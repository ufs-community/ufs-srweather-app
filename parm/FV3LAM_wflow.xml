{#

This is a Jinja-enabled Rocoto XML template. It is filled in using the
fill_template.py script, and is done automatically by the
generate_workflow.sh step of preparing a regional workflow configured
experiment.

See README.xml_templating.md for information on using the Templating mechanisms.
-#}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE workflow [

<!--
Parameters needed by the job scheduler.
-->
<!ENTITY ACCOUNT       "{{ account }}">
<!ENTITY SCHED         "{{ sched }}">
<!ENTITY QUEUE_DEFAULT "{{ queue_default }}">
<!ENTITY QUEUE_HPSS    "{{ queue_hpss }}">
<!ENTITY QUEUE_FCST    "{{ queue_fcst }}">

<!--
Workflow task names.
-->
{%- if sched_native_cmd  %}
<!ENTITY SCHED_NATIVE_CMD                          "{{ sched_native_cmd }}">
{%- else %}
<!ENTITY SCHED_NATIVE_CMD                          "">
{%- endif %}
<!ENTITY TN_MAKE_GRID                              "{{ tn_make_grid }}">
<!ENTITY TN_MAKE_OROG                              "{{ tn_make_orog }}">
<!ENTITY TN_MAKE_SFC_CLIMO                         "{{ tn_make_sfc_climo }}">
<!ENTITY TN_GET_EXTRN_ICS                          "{{ tn_get_extrn_ics }}">
<!ENTITY TN_GET_EXTRN_LBCS                         "{{ tn_get_extrn_lbcs }}">
<!ENTITY TN_MAKE_ICS                               "{{ tn_make_ics }}">
<!ENTITY TN_MAKE_LBCS                              "{{ tn_make_lbcs }}">
<!ENTITY TN_RUN_FCST                               "{{ tn_run_fcst }}">
<!ENTITY TN_RUN_POST                               "{{ tn_run_post }}">
{%- if fcst_len_hrs == -1 %}
<!ENTITY TN_RUN_POST_CYC1                          "{{ tn_run_post }}_c1">
<!ENTITY TN_RUN_POST_CYC2                          "{{ tn_run_post }}_c2">
<!ENTITY TN_RUN_POST_CYC3                          "{{ tn_run_post }}_c3">
<!ENTITY TN_RUN_POST_CYC4                          "{{ tn_run_post }}_c4">
{%- endif%}
{%- if run_task_aqm_ics %}
<!ENTITY TN_AQM_EXTRN_ICS          "{{ tn_aqm_ics }}_ext">
<!ENTITY TN_AQM_ICS                "{{ tn_aqm_ics }}">
{%- endif %}
{%- if run_task_aqm_lbcs %}
<!ENTITY TN_AQM_LBCS               "{{ tn_aqm_lbcs }}">
{%- endif %}
{%- if run_task_nexus_gfs_sfc %}
<!ENTITY TN_NEXUS_GFS_SFC          "{{ tn_nexus_gfs_sfc }}">
{%- endif %}
{%- if run_task_nexus_emission %}
<!ENTITY TN_NEXUS_EMISSION         "{{ tn_nexus_emission }}">
<!ENTITY TN_NEXUS_POST_SPLIT       "{{ tn_nexus_post_split }}">
{%- endif %}
{%- if run_task_fire_emission %}
<!ENTITY TN_FIRE_EMISSION          "{{ tn_fire_emission }}">
{%- endif %}
{%- if run_task_point_source %}
<!ENTITY TN_POINT_SOURCE           "{{ tn_point_source }}">
{%- endif %}
{%- if run_task_pre_post_stat %}
<!ENTITY TN_PRE_POST_STAT          "{{ tn_pre_post_stat }}">
{%- endif %}
{%- if run_task_post_stat_o3 %}
<!ENTITY TN_POST_STAT_O3           "{{ tn_post_stat_o3 }}">
{%- endif %}
{%- if run_task_post_stat_pm25 %}
<!ENTITY TN_POST_STAT_PM25         "{{ tn_post_stat_pm25 }}">
{%- endif %}
{%- if run_task_bias_correction_o3 %}
<!ENTITY TN_BIAS_CORRECTION_O3     "{{ tn_bias_correction_o3 }}">
{%- endif %}
{%- if run_task_bias_correction_pm25 %}
<!ENTITY TN_BIAS_CORRECTION_PM25   "{{ tn_bias_correction_pm25 }}">
{%- endif %}

<!--
Flags that specify whether to run the preprocessing and/or verification tasks.
-->
<!ENTITY RUN_TASK_MAKE_GRID      "{{ run_task_make_grid | upper }}">
<!ENTITY RUN_TASK_MAKE_OROG      "{{ run_task_make_orog | upper }}">
<!ENTITY RUN_TASK_MAKE_SFC_CLIMO "{{ run_task_make_sfc_climo | upper }}">

<!--
Number of physical cores per node for the current machine.  This is used
below in the <nodesize> tag, but that tag is not clearly documented.  This
parameter may be unnecessary since each task now has its own variable that
specifies the number of processes per node being used (the PPN_... entities).
-->
<!ENTITY NCORES_PER_NODE "{{ ncores_per_node }}">

<!--
Directories and files.
-->
<!ENTITY USHdir                   "{{ ushdir }}">
<!ENTITY JOBSdir                  "{{ jobsdir }}">
<!ENTITY SCRIPTSdir               "{{ scriptsdir }}">
<!ENTITY COMIN_BASEDIR            "{{ comin_basedir }}">
<!ENTITY COMOUT_BASEDIR           "{{ comout_basedir }}">
<!ENTITY GLOBAL_VAR_DEFNS_FP      "{{ global_var_defns_fp }}">
<!ENTITY LOAD_MODULES_RUN_TASK_FP "{{ load_modules_run_task_fp }}">
<!ENTITY EXPTDIR                  "{{ exptdir }}">

{%- if do_ensemble %}
<!ENTITY DYN_DIR  "{{ dataroot_dfv }}/run_fcst_{{ ensmem_indx_name }}#{{ ensmem_indx_name }}#.{{ workflow_id }}_<cyclestr>@Y@m@d@H</cyclestr>/dyn">
<!ENTITY PHY_DIR  "{{ dataroot_dfv }}/run_fcst_{{ ensmem_indx_name }}#{{ ensmem_indx_name }}#.{{ workflow_id }}_<cyclestr>@Y@m@d@H</cyclestr>/phy">
{%- else %}
<!ENTITY DYN_DIR  "{{ dataroot_dfv }}/run_fcst.{{ workflow_id }}_<cyclestr>@Y@m@d@H</cyclestr>/dyn">
<!ENTITY PHY_DIR  "{{ dataroot_dfv }}/run_fcst.{{ workflow_id }}_<cyclestr>@Y@m@d@H</cyclestr>/phy">
{%- endif %}
<!ENTITY COMIN_DIR "{{ comin_basedir }}/{{ run_dfv }}.@Y@m@d/@H">

<!ENTITY LOGDIR                   "{{ logbasedir_dfv }}/<cyclestr>@Y@m@d</cyclestr>">
<!ENTITY LOGEXT                   ".{{ workflow_id }}.log" >
<!ENTITY CMPEXT                   "_task_complete.txt">

<!ENTITY MET_INSTALL_DIR "{{ met_install_dir }}">
<!ENTITY METPLUS_PATH "{{ metplus_path }}">
<!ENTITY METPLUS_CONF "{{ metplus_conf }}">
<!ENTITY MET_CONFIG "{{ met_config }}">
<!ENTITY CCPA_OBS_DIR "{{ ccpa_obs_dir }}">
<!ENTITY MRMS_OBS_DIR "{{ mrms_obs_dir }}">
<!ENTITY NDAS_OBS_DIR "{{ ndas_obs_dir }}">

<!ENTITY WARMSTART_CYCLE_DIR  "{{ warmstart_cycle_dir }}">

<!--
Reservation types.  Reservations specify the queue/partition and account
to use for a given task.  The "DEFAULT" reservation type is used for all 
tasks other than TN_GET_EXTRN_ICS, TN_GET_EXTRN_LBCS, and TN_RUN_FCST; 
the "HPSS" type is used for the TN_GET_EXTRN_ICS and TN_GET_EXTRN_LBCS 
tasks; and the "FCST" type is used for the TN_RUN_FCST task.
-->

{%- if partition_default is not none %}
<!ENTITY RSRV_DEFAULT "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue><partition>{{ partition_default }}</partition>">
{%- else %}
<!ENTITY RSRV_DEFAULT "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue>">
{%- endif %}
{%- if partition_hpss is not none %}
<!ENTITY RSRV_HPSS    "<account>&ACCOUNT;</account><queue>&QUEUE_HPSS;</queue><partition>{{ partition_hpss }}</partition>">
{%- else %}
<!ENTITY RSRV_HPSS    "<account>&ACCOUNT;</account><queue>&QUEUE_HPSS;</queue>">
{%- endif %}
{%- if partition_fcst is not none %}
<!ENTITY RSRV_FCST    "<account>&ACCOUNT;</account><queue>&QUEUE_FCST;</queue><partition>{{ partition_fcst }}</partition>">
{%- else %}
<!ENTITY RSRV_FCST    "<account>&ACCOUNT;</account><queue>&QUEUE_FCST;</queue>">
{%- endif %}

]>

<workflow realtime="F" scheduler="&SCHED;" cyclethrottle="200" taskthrottle="{{ taskthrottle }}">
{# Double quotes are required inside the strftime! Expect an error from reading the template if using single quotes. #}
  <cycledef group="at_start">{{ cdate_first_cycl.strftime("%M %H %d %m %Y *") }}</cycledef>
  <cycledef group="forecast">
    {{- date_first_cycl ~ " " ~ date_last_cycl ~ " " ~ cycl_freq -}}
  </cycledef>
{%- if cycl_next != date_first_cycl %}
  <cycledef group="cycled">
    {{- cycl_next ~ " " ~ date_last_cycl ~ " " ~ cycl_freq -}}
  </cycledef>
{%- endif %}
{%- if fcst_len_hrs == -1 %}
  {%- if num_fcst_len_cycl >= 1 %}
  <cycledef group="cyc_1st"> {{- date_first_cycl ~ " " ~ date_1st_last_cycl ~ " " ~ "24:00:00" -}} </cycledef>
  {%- endif %}
  {%- if num_fcst_len_cycl >= 2 %}
  <cycledef group="cyc_2nd"> {{- date_2nd_cycl ~ " " ~ date_2nd_last_cycl ~ " " ~ "24:00:00" -}} </cycledef>
  {%- endif %}
  {%- if num_fcst_len_cycl >= 3 %}
  <cycledef group="cyc_3rd"> {{- date_3rd_cycl ~ " " ~ date_3rd_last_cycl ~ " " ~ "24:00:00" -}} </cycledef>
  {%- endif %}
  {%- if num_fcst_len_cycl >= 4 %}
  <cycledef group="cyc_4th"> {{- date_4th_cycl ~ " " ~ date_4th_last_cycl ~ " " ~ "24:00:00" -}} </cycledef>
  {%- endif %}
{%- endif %}
  <log>
    &LOGDIR;/FV3LAM_wflow.{{ workflow_id }}.log
  </log>

<!-- 
The following command works to call the J-job for a given task (in this
case the TN_MAKE_GRID task) if in the script LOAD_MODULES_RUN_TASK_FP we 
do NOT call exec to run the J-job.  The command first sources the script
LOAD_MODULES_RUN_TASK_FP and then runs the J-job, so it is simpler than
calling exec and thus preferred if NCO accepts it.  Note that the portion
of the command that sources LOAD_MODULES_RUN_TASK_FP also passes an 
argument to it (the argument being the name of the task).  This works in
bash but it probably won't work in sh.

If this method is acceptable to NCO, then for clarity maybe we can
source LOAD_MODULES_RUN_TASK_FP within the J-job instead of here since
we are already sourcing other files in the J-job anyway.
-->
<!--
    <command>{ . &LOAD_MODULES_RUN_TASK_FP; "&TN_MAKE_GRID;";
               &JOBSdir;/JAQM_MAKE_GRID;
             }</command>
-->
<!--
The following command works if we call exec in LOAD_MODULES_RUN_TASK_FP
to run the J-job.  This passes the J-job script as the second argument
to LOAD_MODULES_RUN_TASK_FP (the first argument is the task name).  The
J-job then uses exec to run the J-job (while also terminating the LOAD_-
MODULES_RUN_TASK_FP script.
-->

{%- if run_task_make_grid %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_MAKE_GRID;" cycledefs="at_start" maxtries="{{ maxtries_make_grid }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_MAKE_GRID;" "&JOBSdir;/JAQM_MAKE_GRID"</command>
    <nodes>{{ nnodes_make_grid }}:ppn={{ ppn_make_grid }}</nodes>
    <walltime>{{ wtime_make_grid }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&TN_MAKE_GRID;</jobname>
    <join>&LOGDIR;/&TN_MAKE_GRID;&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>

  </task>
{%- endif %}
{%- if run_task_make_orog %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_MAKE_OROG;" cycledefs="at_start" maxtries="{{ maxtries_make_orog }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_MAKE_OROG;" "&JOBSdir;/JAQM_MAKE_OROG"</command>
    <nodes>{{ nnodes_make_orog }}:ppn={{ ppn_make_orog }}</nodes>
    <walltime>{{ wtime_make_orog }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&TN_MAKE_OROG;</jobname>
    <join>&LOGDIR;/&TN_MAKE_OROG;&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>

    <dependency>
      <or>
<!--        <taskdep task="make_grid"/> -->
        <datadep age="00:00:00:05">&EXPTDIR;/grid/&TN_MAKE_GRID;&CMPEXT;</datadep>
        <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
      </or>
    </dependency>

  </task>
{%- endif %}
{%- if run_task_make_sfc_climo %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_MAKE_SFC_CLIMO;" cycledefs="at_start" maxtries="{{ maxtries_make_sfc_climo }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_MAKE_SFC_CLIMO;" "&JOBSdir;/JAQM_MAKE_SFC_CLIMO"</command>
    <nodes>{{ nnodes_make_sfc_climo }}:ppn={{ ppn_make_sfc_climo }}</nodes>
    <walltime>{{ wtime_make_sfc_climo }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&TN_MAKE_SFC_CLIMO;</jobname>
    <join>&LOGDIR;/&TN_MAKE_SFC_CLIMO;&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>

    <dependency>
      <and>
        <or>
<!--          <taskdep task="&TN_MAKE_GRID;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/grid/&TN_MAKE_GRID;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&TN_MAKE_OROG;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/orog/&TN_MAKE_OROG;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
{%- endif %}
{%- if run_task_nexus_gfs_sfc %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_NEXUS_GFS_SFC;" cycledefs="forecast" maxtries="{{ maxtries_nexus_gfs_sfc }}">

  {%- if do_real_time %}
    &RSRV_DEFAULT;
  {%- else %}
    &RSRV_HPSS;
  {%- endif %}
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_NEXUS_GFS_SFC;" "&JOBSdir;/JAQM_NEXUS_GFS_SFC"</command>
    <nodes>{{ nnodes_nexus_gfs_sfc }}:ppn={{ ppn_nexus_gfs_sfc }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    {%- if not do_real_time %}   
    <memory>{{ mem_nexus_gfs_sfc }}</memory>
    {%- endif %}
  {%- endif %}
    <walltime>{{ wtime_nexus_gfs_sfc }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- if machine not in ["WCOSS2"] %}
    <native>&SCHED_NATIVE_CMD;</native>
  {%- endif %}
    <jobname>&TN_NEXUS_GFS_SFC;</jobname>
    <join>&LOGDIR;/&TN_NEXUS_GFS_SFC;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

</task>
{%- endif %}
{%- if run_task_nexus_emission %}
<!--
************************************************************************
************************************************************************
-->
  <metatask name="&TN_NEXUS_EMISSION;">
    <var name="nspt">{% for h in range(0, num_split_nexus) %}{{ " %02d" % h }}{% endfor %}</var>
      <task name="&TN_NEXUS_EMISSION;_#nspt#" cycledefs="forecast" maxtries="{{ maxtries_nexus_emission }}">
        &RSRV_DEFAULT;
        <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_NEXUS_EMISSION;" "&JOBSdir;/JAQM_NEXUS_EMISSION"</command>
        {%- if machine in ["HERA"]  %}
        <nodes>{{ nnodes_nexus_emission }}:ppn={{ ppn_nexus_emission }}</nodes>
        <native>{{ native_nexus_emission }}</native>
        {%- elif machine in ["WCOSS2"]  %}
        <nodes>{{ nnodes_nexus_emission }}:ppn={{ ppn_nexus_emission }}:tpp={{ omp_num_threads_nexus_emission }}</nodes>
        <native>&SCHED_NATIVE_CMD;</native>
        {%- else %}
        <nodes>{{ nnodes_nexus_emission }}:ppn={{ ppn_nexus_emission }}</nodes>    
        {%- endif %}
        <walltime>{{ wtime_nexus_emission }}</walltime>
        <nodesize>&NCORES_PER_NODE;</nodesize>
        <jobname>&TN_NEXUS_EMISSION;_#nspt#</jobname>
        <join>&LOGDIR;/&TN_NEXUS_EMISSION;<cyclestr>_@Y@m@d@H_s#nspt#&LOGEXT;</cyclestr></join>

        <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
        <envar><name>USHdir</name><value>&USHdir;</value></envar>
	<envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
        <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
        <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
        <envar><name>nspt</name><value>#nspt#</value></envar>
	<envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
	<envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

{%- if run_task_nexus_gfs_sfc %}	
        <dependency>
          <taskdep task="&TN_NEXUS_GFS_SFC;"/>    
	</dependency>
{%- endif %}
      </task>
  </metatask>      
  <task name="&TN_NEXUS_POST_SPLIT;" cycledefs="forecast" maxtries="{{ maxtries_nexus_post_split }}">
    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_NEXUS_POST_SPLIT;" "&JOBSdir;/JAQM_NEXUS_POST_SPLIT"</command>
    <nodes>{{ nnodes_nexus_post_split }}:ppn={{ ppn_nexus_post_split }}</nodes>
    <walltime>{{ wtime_nexus_post_split }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TN_NEXUS_POST_SPLIT;</jobname>
    <join>&LOGDIR;/&TN_NEXUS_POST_SPLIT;<cyclestr>_@Y@m@d@H&LOGEXT;</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <metataskdep metatask="&TN_NEXUS_EMISSION;"/>
    </dependency>

  </task>
{%- endif %}
{%- if run_task_fire_emission %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_FIRE_EMISSION;" cycledefs="forecast" maxtries="{{ maxtries_fire_emission }}">

  {%- if do_aqm_save_fire %}
    &RSRV_HPSS;
  {%- else %}
    &RSRV_DEFAULT;
  {%- endif %}
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_FIRE_EMISSION;" "&JOBSdir;/JAQM_FIRE_EMISSION"</command>
    <nodes>{{ nnodes_fire_emission }}:ppn={{ ppn_fire_emission }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
  {%- if not do_real_time %}
    <memory>{{ mem_fire_emission }}</memory>
  {%- endif %}
  {%- endif %}
    <walltime>{{ wtime_fire_emission }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- if machine not in ["WCOSS2"] %}
    <native>&SCHED_NATIVE_CMD;</native>
  {%- endif %}
    <jobname>&TN_FIRE_EMISSION;</jobname>
    <join>&LOGDIR;/&TN_FIRE_EMISSION;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
  </task>
{%- endif %}
{%- if run_task_point_source %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_POINT_SOURCE;" cycledefs="forecast" maxtries="{{ maxtries_point_source }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_POINT_SOURCE;" "&JOBSdir;/JAQM_POINT_SOURCE"</command>
    <nodes>{{ nnodes_point_source }}:ppn={{ ppn_point_source }}</nodes>    
    <walltime>{{ wtime_point_source }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TN_POINT_SOURCE;</jobname>
    <join>&LOGDIR;/&TN_POINT_SOURCE;<cyclestr>_@Y@m@d@H&LOGEXT;</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>    
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
<!-- <taskdep task="&TN_MAKE_GRID;"/> -->
      <or>
        <datadep age="00:00:00:05">&EXPTDIR;/grid/&TN_MAKE_GRID;&CMPEXT;</datadep>
        <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
      </or>
    </dependency>

  </task>
{%- endif %}
{%- if run_task_get_extrn_ics %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_GET_EXTRN_ICS;" cycledefs="forecast" maxtries="{{ maxtries_get_extrn_ics }}">

    &RSRV_HPSS;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_GET_EXTRN_ICS;" "&JOBSdir;/JAQM_GET_EXTRN_MDL_FILES"</command>
    <nodes>{{ nnodes_get_extrn_ics }}:ppn={{ ppn_get_extrn_ics }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_get_extrn_ics }}</memory>
  {%- endif %}
    <walltime>{{ wtime_get_extrn_ics }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- if machine not in ["WCOSS2"] %}
    <native>&SCHED_NATIVE_CMD;</native>
  {%- endif %}
    <jobname>&TN_GET_EXTRN_ICS;</jobname>
    <join>&LOGDIR;/&TN_GET_EXTRN_ICS;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>ICS</value></envar>
  </task>
{%- endif %}
{%- if run_task_get_extrn_lbcs %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_GET_EXTRN_LBCS;" cycledefs="forecast" maxtries="{{ maxtries_get_extrn_lbcs }}">

    &RSRV_HPSS;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_GET_EXTRN_LBCS;" "&JOBSdir;/JAQM_GET_EXTRN_MDL_FILES"</command>
    <nodes>{{ nnodes_get_extrn_lbcs }}:ppn={{ ppn_get_extrn_lbcs }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_get_extrn_lbcs }}</memory>
  {%- endif %}
    <walltime>{{ wtime_get_extrn_lbcs }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- if machine not in ["WCOSS2"] %}
    <native>&SCHED_NATIVE_CMD;</native>
  {%- endif %}
    <jobname>&TN_GET_EXTRN_LBCS;</jobname>
    <join>&LOGDIR;/&TN_GET_EXTRN_LBCS;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>LBCS</value></envar>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if do_ensemble %}
  <metatask name="run_ensemble">

    <var name="{{ ensmem_indx_name }}">{% for m in range(1, num_ens_members+1) %}{{ "%03d " % m }}{% endfor %}</var>

{%- endif %}

{%- if run_task_make_ics %}
  <task name="&TN_MAKE_ICS;{{ uscore_ensmem_name }}" cycledefs="forecast" maxtries="{{ maxtries_make_ics }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_MAKE_ICS;" "&JOBSdir;/JAQM_MAKE_ICS"</command>
    <nodes>{{ nnodes_make_ics }}:ppn={{ ppn_make_ics }}</nodes>
    <walltime>{{ wtime_make_ics }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&TN_MAKE_ICS;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&TN_MAKE_ICS;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <dependency>
      <and>
{%- if run_task_get_extrn_ics %}
        <taskdep task="&TN_GET_EXTRN_ICS;"/>
{%- endif %}
        <or>
<!--          <taskdep task="&TN_MAKE_GRID;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/grid/&TN_MAKE_GRID;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&TN_MAKE_OROG;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/orog/&TN_MAKE_OROG;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&TN_MAKE_SFC_CLIMO;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/sfc_climo/&TN_MAKE_SFC_CLIMO;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
{%- endif %}
{%- if run_task_make_lbcs %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_MAKE_LBCS;{{ uscore_ensmem_name }}" cycledefs="forecast" maxtries="{{ maxtries_make_lbcs }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_MAKE_LBCS;" "&JOBSdir;/JAQM_MAKE_LBCS"</command>
    <nodes>{{ nnodes_make_lbcs }}:ppn={{ ppn_make_lbcs }}</nodes>
    <walltime>{{ wtime_make_lbcs }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&TN_MAKE_LBCS;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&TN_MAKE_LBCS;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <dependency>
      <and>
{%- if run_task_get_extrn_lbcs %}
        <taskdep task="&TN_GET_EXTRN_LBCS;"/>
{%- endif %}
        <or>
<!--          <taskdep task="&TN_MAKE_GRID;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/grid/&TN_MAKE_GRID;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&TN_MAKE_OROG;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/orog/&TN_MAKE_OROG;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&TN_MAKE_SFC_CLIMO;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/sfc_climo/&TN_MAKE_SFC_CLIMO;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
{%- endif %}
{%- if run_task_aqm_ics %}
  {%- if not coldstart %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_AQM_EXTRN_ICS;" cycledefs="at_start" maxtries="{{ maxtries_aqm_ics }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_AQM_ICS;" "&JOBSdir;/JAQM_ICS"</command>
    <nodes>{{ nnodes_aqm_ics }}:ppn={{ ppn_aqm_ics }}</nodes>
    <walltime>{{ wtime_aqm_ics }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TN_AQM_EXTRN_ICS;</jobname>
    <join>&LOGDIR;/&TN_AQM_EXTRN_ICS;<cyclestr>_@Y@m@d@H&LOGEXT;</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>    
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>PREV_CYCLE_DIR</name><value>&WARMSTART_CYCLE_DIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&TN_MAKE_ICS;"/>
        <or>
          <datadep age="00:00:00:05">&WARMSTART_CYCLE_DIR;/RESTART/<cyclestr>@Y@m@d.@H@M@S.fv_tracer.res.tile1.nc</cyclestr></datadep>
          <datadep age="00:00:00:05">&WARMSTART_CYCLE_DIR;/RESTART/fv_tracer.res.tile1.nc</datadep>
        </or>
      </and>
    </dependency>

  </task>
  {%- endif %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_AQM_ICS;" cycledefs="cycled" maxtries="{{ maxtries_aqm_ics }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_AQM_ICS;" "&JOBSdir;/JAQM_ICS"</command>
    <nodes>{{ nnodes_aqm_ics }}:ppn={{ ppn_aqm_ics }}</nodes>
    <walltime>{{ wtime_aqm_ics }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TN_AQM_ICS;</jobname>
    <join>&LOGDIR;/&TN_AQM_ICS;<cyclestr>_@Y@m@d@H&LOGEXT;</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>PREV_CYCLE_DIR</name><value><cyclestr offset="-{{- cycl_freq -}}">&COMIN_DIR;</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&TN_MAKE_ICS;"/>
        <or>
          <datadep age="00:00:00:05"><cyclestr offset="-{{- cycl_freq -}}">&COMIN_DIR;</cyclestr>/RESTART/<cyclestr>@Y@m@d.@H@M@S.fv_tracer.res.tile1.nc</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-{{- cycl_freq -}}">&COMIN_DIR;</cyclestr>/RESTART/fv_tracer.res.tile1.nc</datadep>
        </or>
      </and>
    </dependency>

  </task>
{%- endif %}
{%- if run_task_aqm_lbcs %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_AQM_LBCS;" cycledefs="forecast" maxtries="{{ maxtries_aqm_lbcs }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_AQM_LBCS;" "&JOBSdir;/JAQM_LBCS"</command>
    <nodes>{{ nnodes_aqm_lbcs }}:ppn={{ ppn_aqm_lbcs }}</nodes>
    <walltime>{{ wtime_aqm_lbcs }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TN_AQM_LBCS;</jobname>
    <join>&LOGDIR;/&TN_AQM_LBCS;<cyclestr>_@Y@m@d@H&LOGEXT;</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>    
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&TN_MAKE_ICS;"/>
        <taskdep task="&TN_MAKE_LBCS;"/>
      </and>
    </dependency>

  </task>
{%- endif %}
{%- if run_task_run_fcst %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_RUN_FCST;{{ uscore_ensmem_name }}" cycledefs="forecast" maxtries="{{ maxtries_run_fcst }}">

    &RSRV_FCST;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_RUN_FCST;" "&JOBSdir;/JAQM_FORECAST"</command>
  {%- if machine in ["JET", "HERA", "LINUX"]  %}
    <cores>{{ ncores_run_fcst }}</cores>
    <native>{{ native_run_fcst }}</native>
  {%- elif machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}:tpp={{ omp_num_threads_run_fcst }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- else %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- endif %}
    <native>&SCHED_NATIVE_CMD;</native>
    <walltime>{{ wtime_run_fcst }}</walltime>
    <jobname>&TN_RUN_FCST;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&TN_RUN_FCST;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&TN_MAKE_ICS;{{ uscore_ensmem_name }}"/>
        <taskdep task="&TN_MAKE_LBCS;{{ uscore_ensmem_name }}"/>
{%- if run_task_nexus_emission %}
        <taskdep task="&TN_NEXUS_POST_SPLIT;"/>
{%- endif %}
{%- if run_task_fire_emission %}
        <taskdep task="&TN_FIRE_EMISSION;"/>
{%- endif %}
{%- if run_task_point_source %}
        <taskdep task="&TN_POINT_SOURCE;"/>
{%- endif %}
{%- if run_task_aqm_ics %}
        <or>
          <taskdep task="&TN_AQM_ICS;"/>
{%- if not coldstart %}
          <and>
            <not><cycleexistdep cycle_offset="-{{- cycl_freq -}}"/></not>
            <taskdep task="&TN_AQM_EXTRN_ICS;"/>
          </and>
{%- else %}
          <not><cycleexistdep cycle_offset="-{{- cycl_freq -}}"/></not>
{%- endif %}
        </or>
{%- endif %}
{%- if run_task_aqm_lbcs %}
        <taskdep task="&TN_AQM_LBCS;"/>
{%- endif %}
      </and>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_run_post %}
{%- if fcst_len_hrs == -1 %}
  {%- for icyc in range(num_fcst_len_cycl) %}
  <metatask name="&TN_RUN_POST;{{ uscore_ensmem_name }}">
    <var name="fhr">{% for h in range(0, fcst_len_cycl[icyc]+1) %}{{ " %03d" % h }}{% endfor %}</var>
      {%- if icyc == 0 %}
      <task name="&TN_RUN_POST_CYC1;{{ uscore_ensmem_name }}_f#fhr#" cycledefs="cyc_1st" maxtries="{{ maxtries_run_post }}">
      {%- elif icyc == 1 %}
      <task name="&TN_RUN_POST_CYC2;{{ uscore_ensmem_name }}_f#fhr#" cycledefs="cyc_2nd" maxtries="{{ maxtries_run_post }}">
      {%- elif icyc == 2 %}
      <task name="&TN_RUN_POST_CYC3;{{ uscore_ensmem_name }}_f#fhr#" cycledefs="cyc_3rd" maxtries="{{ maxtries_run_post }}">
      {%- elif icyc == 3 %}
      <task name="&TN_RUN_POST_CYC4;{{ uscore_ensmem_name }}_f#fhr#" cycledefs="cyc_4th" maxtries="{{ maxtries_run_post }}">
      {%- endif %}
        &RSRV_DEFAULT;
        <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_RUN_POST;" "&JOBSdir;/JAQM_POST"</command>
        <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
        <walltime>{{ wtime_run_post }}</walltime>
        <nodesize>&NCORES_PER_NODE;</nodesize>
        <native>&SCHED_NATIVE_CMD;</native>
      {%- if icyc == 0 %}
        <jobname>&TN_RUN_POST_CYC1;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      {%- elif icyc == 1 %}
        <jobname>&TN_RUN_POST_CYC2;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      {%- elif icyc == 2 %}
        <jobname>&TN_RUN_POST_CYC3;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      {%- elif icyc == 3 %}
        <jobname>&TN_RUN_POST_CYC4;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      {%- endif %}
	<join>&LOGDIR;/&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>
        <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
        <envar><name>USHdir</name><value>&USHdir;</value></envar>
        <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
        <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
        <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
        <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
        <envar><name>fhr</name><value>#fhr#</value></envar>
        <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
        <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

        <dependency>
          <or>
            <taskdep task="&TN_RUN_FCST;{{ uscore_ensmem_name }}"/>
      {%- if not cpl_aqm %}
	    <and>
              <datadep age="05:00">&DYN_DIR;f#fhr#.nc</datadep>
              <datadep age="05:00">&PHY_DIR;f#fhr#.nc</datadep>
	    </and>
      {%- endif %}
	  </or>
        </dependency>

      </task>
  </metatask>
  {%- endfor %}

{%- else %}
  {%- if sub_hourly_post %}
<!--
Define the post-processing task for first model output time.  The forecast 
hour corresponding to this output time is zero (formatted to the appropriate
number of digits), and the corresponding forecast minute is the first model 
time step dt_atmos, i.e. it is not zero.  This is because FV3 is designed 
such that its first output file contains fields at the first time step.  
It is for this reason that this task is not rolled into the metatask(s) 
further below.

Note that we wrap this task in a metatask in order to be able to declare
and use the variables fhr and fmn.  This allows the block of code inside
the <task> tag (except for the dependencies) to be identical to the ones 
later below for other output times.
-->
  <metatask>

    <var name="fhr">000</var>
    <var name="fmn">00</var>
    <task name="&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr##fmn#" cycledefs="forecast" maxtries="{{ maxtries_run_post }}">

      &RSRV_DEFAULT;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_RUN_POST;" "&JOBSdir;/JAQM_POST"</command>
      <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
      <walltime>{{ wtime_run_post }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <native>&SCHED_NATIVE_CMD;</native>
      <jobname>&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr##fmn#</jobname>
      <join>&LOGDIR;/&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr##fmn#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>fmn</name><value>#fmn#</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

<!--
Note that because the forecast minutes and seconds corresponding to the
first model output time are not exactly zero, we use the jinja template
variable first_fv3_file_tstr instead of fhr and fmn to form the file 
names in the dependencies.
-->
      <dependency>
        <or>
          <taskdep task="&TN_RUN_FCST;{{ uscore_ensmem_name }}"/>
      {%- if not cpl_aqm %}
	  <and>
            <datadep age="05:00">&DYN_DIR;f{{ first_fv3_file_tstr }}.nc</datadep>
            <datadep age="05:00">&PHY_DIR;f{{ first_fv3_file_tstr }}.nc</datadep>
          </and>
      {%- endif %}
        </or>
      </dependency>

    </task>

  </metatask>

<!--
Define the post-processing tasks for the second through last output minutes
of the first output hour (which is zero).  We use two metatasks for this.
The inner one is needed to loop over the minutes, and the outer one is
used in order to be able to declare and use the variable fhr.  Use of this
variable (along with the fmn variable in the inner metatask) allows the
block of code inside the <task> tag to be identical to the ones later below
for other output times.
-->
  <metatask name="&TN_RUN_POST;{{ uscore_ensmem_name }}_f000">

    <var name="fhr">000</var>
    <metatask>

      <var name="fmn">{% for min in range(delta_min, 60, delta_min) %}{{ " %02d" % min }}{% endfor %}</var>
      <task name="&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr##fmn#" cycledefs="forecast" maxtries="{{ maxtries_run_post }}">

        &RSRV_DEFAULT;
        <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_RUN_POST;" "&JOBSdir;/JAQM_POST"</command>
        <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
        <walltime>{{ wtime_run_post }}</walltime>
        <nodesize>&NCORES_PER_NODE;</nodesize>
        <native>&SCHED_NATIVE_CMD;</native>
        <jobname>&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr##fmn#</jobname>
	<join>&LOGDIR;/&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr##fmn#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

        <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
        <envar><name>USHdir</name><value>&USHdir;</value></envar>
        <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
        <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
        <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
        <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
        <envar><name>fhr</name><value>#fhr#</value></envar>
        <envar><name>fmn</name><value>#fmn#</value></envar>
        <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
        <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

        <dependency>
          <or>
            <taskdep task="&TN_RUN_FCST;{{ uscore_ensmem_name }}"/>
      {%- if not cpl_aqm %}
            <and>
              <datadep age="05:00">&DYN_DIR;f#fhr#:#fmn#:00.nc</datadep>
              <datadep age="05:00">&PHY_DIR;f#fhr#:#fmn#:00.nc</datadep>
            </and>
      {%- endif %}
          </or>
        </dependency>

      </task>

    </metatask>

  </metatask>
  {%- endif %}

  <metatask name="&TN_RUN_POST;{{ uscore_ensmem_name }}">
  {%- if sub_hourly_post %}
<!--
Define the post-processing tasks for the second through next-to-last model
output hours (and all output minutes for each such hour).  
-->
    <var name="fhr">{% for h in range(1, fcst_len_hrs) %}{{ " %03d" % h }}{% endfor %}</var>
    <metatask>
      <var name="fmn">{% for min in range(0, 60, delta_min) %}{{ " %02d" % min }}{% endfor %}</var>
      <task name="&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr##fmn#" cycledefs="forecast" maxtries="{{ maxtries_run_post }}">
  {%- else %}
<!--
Define the post-processing tasks for each model output hour.  Note that
only one metatask is needed for this purpose (the inner one that loops 
over the hours), but we use two metatasks in order to be able to use the 
variable fmn, which here is always set to zero.  Use of this variable 
(along with the fhr variable in the inner metatask) allows the block of 
code inside the <task> tag to be identical to the case in which subhourly 
post-processing is performed (i.e. the case in which the minutes are not 
always zero).
-->
    <var name="fhr">{% for h in range(0, fcst_len_hrs+1) %}{{ " %03d" % h }}{% endfor %}</var>
      <task name="&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr#" cycledefs="forecast" maxtries="{{ maxtries_run_post }}">
  {%- endif %}

        &RSRV_DEFAULT;
        <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_RUN_POST;" "&JOBSdir;/JAQM_POST"</command>
        <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
        <walltime>{{ wtime_run_post }}</walltime>
        <nodesize>&NCORES_PER_NODE;</nodesize>
        <native>&SCHED_NATIVE_CMD;</native>
        {%- if sub_hourly_post %}
        <jobname>&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr##fmn#</jobname>
	<join>&LOGDIR;/&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr##fmn#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>
        {%- else %}
        <jobname>&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr#</jobname>
	<join>&LOGDIR;/&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>
        {%- endif %}

        <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
        <envar><name>USHdir</name><value>&USHdir;</value></envar>
        <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
        <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
        <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
        <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
        {%- if sub_hourly_post %}
        <envar><name>fhr</name><value>#fhr#</value></envar>
        <envar><name>fmn</name><value>#fmn#</value></envar>
        {%- else %}
        <envar><name>fhr</name><value>#fhr#</value></envar>
        {%- endif %}
        <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
        <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

        <dependency>
          <or>
            <taskdep task="&TN_RUN_FCST;{{ uscore_ensmem_name }}"/>
      {%- if not cpl_aqm %}
            <and>
            {%- if sub_hourly_post %}
              <datadep age="05:00">&DYN_DIR;f#fhr#:#fmn#:00.nc</datadep>
              <datadep age="05:00">&PHY_DIR;f#fhr#:#fmn#:00.nc</datadep>
            {%- else %}
              <datadep age="05:00">&DYN_DIR;f#fhr#.nc</datadep>
              <datadep age="05:00">&PHY_DIR;f#fhr#.nc</datadep>
            {%- endif %}
            </and>
      {%- endif %}
          </or>
        </dependency>

      </task>

    {%- if sub_hourly_post %}
    </metatask>
    {%- else %}
    {%- endif %}
  </metatask>

  {%- if sub_hourly_post %}
<!--
Define the post-processing task for the last model output time.  The 
forecast hour corresponding to this output time is the length of the 
forecast (assuming it is specified in integer hours), and the corresponding 
minute is 0.  This task cannot be included in the metatask above because 
for a given hour, the latter loops over all the valid output minutes, 
whereas for this last hour, only the first minute must be considered.

Note that we wrap this task in a metatask in order to be able to declare
and use the variables fhr and fmn.  This allows the block of code inside
the <task> tag to be identical to the ones above for other output times.
-->
  <metatask>

    <var name="fhr">{{ "%03d" % fcst_len_hrs }}</var>
    <var name="fmn">00</var>
    <task name="&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr##fmn#" cycledefs="forecast" maxtries="{{ maxtries_run_post }}">

      &RSRV_DEFAULT;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_RUN_POST;" "&JOBSdir;/JAQM_POST"</command>
      <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
      <walltime>{{ wtime_run_post }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <native>&SCHED_NATIVE_CMD;</native>
      <jobname>&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr##fmn#</jobname>
      <join>&LOGDIR;/&TN_RUN_POST;{{ uscore_ensmem_name }}_f#fhr##fmn#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>fmn</name><value>#fmn#</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <dependency>
        <or>
          <taskdep task="&TN_RUN_FCST;{{ uscore_ensmem_name }}"/>
      {%- if not cpl_aqm %}
          <and>
            <datadep age="05:00">&DYN_DIR;f#fhr#:#fmn#:00.nc</datadep>
            <datadep age="05:00">&PHY_DIR;f#fhr#:#fmn#:00.nc</datadep>
          </and>
      {%- endif %}
        </or>
      </dependency>

    </task>

  </metatask>
  {%- endif %}
{%- endif %}
{%- endif %}
{%- if run_task_pre_post_stat %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_PRE_POST_STAT;" cycledefs="forecast" maxtries="{{ maxtries_pre_post_stat }}">
    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_PRE_POST_STAT;" "&JOBSdir;/JAQM_PRE_POST_STAT"</command>
    <nodes>{{ nnodes_pre_post_stat }}:ppn={{ ppn_pre_post_stat }}</nodes>
    <walltime>{{ wtime_pre_post_stat }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TN_PRE_POST_STAT;</jobname>
    <join>&LOGDIR;/&TN_PRE_POST_STAT;<cyclestr>_@Y@m@d@H&LOGEXT;</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>    
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar> 
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>    
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <taskdep task="&TN_RUN_FCST;{{ uscore_ensmem_name }}"/>
    </dependency>
  </task>
{%- endif %}
{%- if run_task_post_stat_o3 %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_POST_STAT_O3;" cycledefs="forecast" maxtries="{{ maxtries_post_stat_o3 }}">
    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_POST_STAT_O3;" "&JOBSdir;/JAQM_POST_STAT_O3"</command>
    <nodes>{{ nnodes_post_stat_o3 }}:ppn={{ ppn_post_stat_o3 }}</nodes>
{%- if machine not in ["GAEA"]  %}
    <memory>{{ mem_post_stat_o3 }}</memory>
{%- endif %}
    <walltime>{{ wtime_post_stat_o3 }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TN_POST_STAT_O3;</jobname>
    <join>&LOGDIR;/&TN_POST_STAT_O3;<cyclestr>_@Y@m@d@H&LOGEXT;</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>    
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar> 
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>    
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <taskdep task="&TN_PRE_POST_STAT;"/>
    </dependency>

  </task>
{%- endif %}
{%- if run_task_post_stat_pm25 %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_POST_STAT_PM25;" cycledefs="forecast" maxtries="{{ maxtries_post_stat_pm25 }}">
    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_POST_STAT_PM25;" "&JOBSdir;/JAQM_POST_STAT_PM25"</command>
    <nodes>{{ nnodes_post_stat_pm25 }}:ppn={{ ppn_post_stat_pm25 }}</nodes>
{%- if machine not in ["GAEA"]  %}
    <memory>{{ mem_post_stat_pm25 }}</memory>
{%- endif %}    
    <walltime>{{ wtime_post_stat_pm25 }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TN_POST_STAT_PM25;</jobname>
    <join>&LOGDIR;/&TN_POST_STAT_PM25;<cyclestr>_@Y@m@d@H&LOGEXT;</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>    
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar> 
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>    
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <taskdep task="&TN_PRE_POST_STAT;"/>
    </dependency>

  </task>
{%- endif %}
{%- if run_task_bias_correction_o3 %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_BIAS_CORRECTION_O3;" cycledefs="forecast" maxtries="{{ maxtries_bias_correction_o3 }}">
    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_BIAS_CORRECTION_O3;" "&JOBSdir;/JAQM_BIAS_CORRECTION_O3"</command>
{%- if machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_bias_correction_o3 }}:ppn={{ ppn_bias_correction_o3 }}:tpp={{ omp_num_threads_bias_correction_o3 }}</nodes>
{%- else %}
    <nodes>{{ nnodes_bias_correction_o3 }}:ppn={{ ppn_bias_correction_o3 }}</nodes>
{%- endif %}
{%- if machine not in ["GAEA"]  %}
    <memory>{{ mem_bias_correction_o3 }}</memory>
{%- endif %}
    <walltime>{{ wtime_bias_correction_o3 }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TN_BIAS_CORRECTION_O3;</jobname>
    <join>&LOGDIR;/&TN_BIAS_CORRECTION_O3;<cyclestr>_@Y@m@d@H&LOGEXT;</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>    
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar> 
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>    
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <taskdep task="&TN_PRE_POST_STAT;"/>
    </dependency>

  </task>
{%- endif %}
{%- if run_task_bias_correction_pm25 %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&TN_BIAS_CORRECTION_PM25;" cycledefs="forecast" maxtries="{{ maxtries_bias_correction_pm25 }}">
    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&TN_BIAS_CORRECTION_PM25;" "&JOBSdir;/JAQM_BIAS_CORRECTION_PM25"</command>
{%- if machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_bias_correction_pm25 }}:ppn={{ ppn_bias_correction_pm25 }}:tpp={{ omp_num_threads_bias_correction_pm25 }}</nodes>
{%- else %}
    <nodes>{{ nnodes_bias_correction_pm25 }}:ppn={{ ppn_bias_correction_pm25 }}</nodes>
{%- endif %}
{%- if machine not in ["GAEA"]  %}
    <memory>{{ mem_bias_correction_pm25 }}</memory>
{%- endif %}
    <walltime>{{ wtime_bias_correction_pm25 }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TN_BIAS_CORRECTION_PM25;</jobname>
    <join>&LOGDIR;/&TN_BIAS_CORRECTION_PM25;<cyclestr>_@Y@m@d@H&LOGEXT;</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>    
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar> 
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>    
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <taskdep task="&TN_PRE_POST_STAT;"/>
    </dependency>

  </task>
{%- endif %}

</workflow>
