{#

This is a Jinja-enabled Rocoto XML template. It is filled in using the
fill_template.py script, and is done automatically by the
generate_workflow.sh step of preparing a regional workflow configured
experiment.

See README.xml_templating.md for information on using the Templating mechanisms.
-#}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE workflow [

<!--
Parameters needed by the job scheduler.
-->
<!ENTITY ACCOUNT            "{{ account }}">
<!ENTITY SERVICE_ACCOUNT    "{{ service_account }}">
<!ENTITY SCHED              "{{ sched }}">
<!ENTITY QUEUE_DEFAULT      "{{ queue_default }}">
<!ENTITY QUEUE_HPSS         "{{ queue_hpss }}">
<!ENTITY QUEUE_FCST         "{{ queue_fcst }}">
<!ENTITY QUEUE_POST         "{{ queue_post }}">
<!ENTITY QUEUE_PRDGEN       "{{ queue_prdgen }}">
<!ENTITY QUEUE_ANALYSIS     "{{ queue_analysis }}">
<!ENTITY QUEUE_GRAPHICS     "{{ queue_graphics }}">
<!ENTITY RRFS_RESERVE       {% if reservation %}"--reservation={{ reservation }}"{% else %}""{% endif %}>
<!ENTITY RRFS_POST_RESERVE  {% if reservation_post %}"--reservation={{ reservation_post }}"{% else %}""{% endif %}>

<!--
Workflow task names.
-->
{%- if sched_native_cmd  %}
<!ENTITY SCHED_NATIVE_CMD          "{{ sched_native_cmd }}">
{%- else %}
<!ENTITY SCHED_NATIVE_CMD          "">
{%- endif %}
<!ENTITY MAKE_GRID_TN              "{{ make_grid_tn }}">
<!ENTITY MAKE_OROG_TN              "{{ make_orog_tn }}">
<!ENTITY MAKE_SFC_CLIMO_TN         "{{ make_sfc_climo_tn }}">
<!ENTITY GET_EXTRN_ICS_TN          "{{ get_extrn_ics_tn }}">
<!ENTITY GET_EXTRN_LBCS_TN         "{{ get_extrn_lbcs_tn }}">
<!ENTITY GET_EXTRN_LBCS_LONG_TN    "{{ get_extrn_lbcs_long_tn }}">
<!ENTITY MAKE_ICS_TN               "{{ make_ics_tn }}">
<!ENTITY MAKE_LBCS_TN              "{{ make_lbcs_tn }}">
<!ENTITY RUN_FCST_TN               "{{ run_fcst_tn }}">
<!ENTITY RUN_POST_TN               "{{ run_post_tn }}">
<!ENTITY RUN_PRDGEN_TN             "{{ run_prdgen_tn }}">
<!ENTITY RUN_BUFRSND_TN            "{{ run_bufrsnd_tn }}">
<!ENTITY ANAL_GSI_TN               "{{ anal_gsi_tn }}">
<!ENTITY POSTANAL_TN               "{{ postanal_tn }}">
<!ENTITY OBSERVER_GSI_ENSMEAN_TN   "{{ observer_gsi_ensmean_tn }}">
<!ENTITY OBSERVER_GSI_TN           "{{ observer_gsi_tn }}">
<!ENTITY PREP_CYC_SPINUP_TN        "{{ prep_cyc_spinup_tn }}">
<!ENTITY PREP_CYC_PROD_TN          "{{ prep_cyc_prod_tn }}">
<!ENTITY PREP_CYC_TN               "{{ prep_cyc_tn }}">
<!ENTITY CALC_ENSMEAN_TN           "{{ calc_ensmean_tn }}">

<!ENTITY PROCESS_RADAR_REF_TN      "{{ process_radar_ref_tn }}">
<!ENTITY PROCESS_LIGHTNING_TN      "{{ process_lightning_tn }}">
<!ENTITY PROCESS_BUFR_TN           "{{ process_bufr_tn }}">
<!ENTITY RADAR_REFL2TTEN_TN        "{{ radar_refl2tten_tn }}">
<!ENTITY CLDANL_NONVAR_TN          "{{ cldanl_nonvar_tn }}">
<!ENTITY SAVE_RESTART_TN           "{{ save_restart_tn }}">
<!ENTITY SAVE_INPUT_TN             "{{ save_input_tn }}">
<!ENTITY JEDI_ENVAR_IODA_TN        "{{ jedi_envar_ioda_tn }}">
<!ENTITY PROCESS_SMOKE_TN          "{{ process_smoke_tn }}">
<!ENTITY RUN_CLEAN_TN              "{{ run_clean_tn }}">
<!ENTITY RUN_ARCHIVE_TN            "{{ run_archive_tn }}">

<!ENTITY RUN_PREPSTART_TN          "run_prepstart">
<!ENTITY RUN_ANAL_TN               "run_anal_gsi">
<!ENTITY HYBRID_RADAR_REF_TN       "hybrid_radar_ref">
<!ENTITY RUN_ENKFUPDT_TN           "run_enkfupdt">
<!ENTITY ENKF_RADAR_REF_TN         "enkf_radarref">
<!ENTITY RUN_BUFR_TN               "run_bufr">
<!ENTITY RUN_NCL_TN                "run_ncl">
<!ENTITY RUN_NCL_ZIP_TN            "run_ncl_zip">
<!ENTITY RUN_SMOKE_TN              "run_proc_smoke">

<!ENTITY TAG                       "{{ tag }}">

<!ENTITY GET_OBS                   "{{ get_obs }}">
<!ENTITY GET_OBS_CCPA_TN           "{{ get_obs_ccpa_tn }}">
<!ENTITY GET_OBS_NDAS_TN           "{{ get_obs_ndas_tn }}">
<!ENTITY GET_OBS_MRMS_TN           "{{ get_obs_mrms_tn }}">
<!ENTITY PROCESS_BUFR_TN           "{{ process_bufr_tn }}">
<!ENTITY VX_TN                     "{{ vx_tn }}">
<!ENTITY VX_GRIDSTAT_TN            "{{ vx_gridstat_tn }}">
<!ENTITY VX_GRIDSTAT_REFC_TN       "{{ vx_gridstat_refc_tn }}">
<!ENTITY VX_GRIDSTAT_RETOP_TN      "{{ vx_gridstat_retop_tn }}">
<!ENTITY VX_GRIDSTAT_03h_TN        "{{ vx_gridstat_03h_tn }}">
<!ENTITY VX_GRIDSTAT_06h_TN        "{{ vx_gridstat_06h_tn }}">
<!ENTITY VX_GRIDSTAT_24h_TN        "{{ vx_gridstat_24h_tn }}">
<!ENTITY VX_POINTSTAT_TN           "{{ vx_pointstat_tn }}">
<!ENTITY VX_ENSGRID_TN             "{{ vx_ensgrid_tn }}">
<!ENTITY VX_ENSGRID_REFC_TN        "{{ vx_ensgrid_refc_tn }}">
<!ENTITY VX_ENSGRID_RETOP_TN       "{{ vx_ensgrid_retop_tn }}">
<!ENTITY VX_ENSGRID_03h_TN         "{{ vx_ensgrid_03h_tn }}">
<!ENTITY VX_ENSGRID_06h_TN         "{{ vx_ensgrid_06h_tn }}">
<!ENTITY VX_ENSGRID_24h_TN         "{{ vx_ensgrid_24h_tn }}">
<!ENTITY VX_ENSGRID_MEAN_TN        "{{ vx_ensgrid_mean_tn }}">
<!ENTITY VX_ENSGRID_PROB_TN        "{{ vx_ensgrid_prob_tn }}">
<!ENTITY VX_ENSGRID_MEAN_03h_TN    "{{ vx_ensgrid_mean_03h_tn }}">
<!ENTITY VX_ENSGRID_PROB_03h_TN    "{{ vx_ensgrid_prob_03h_tn }}">
<!ENTITY VX_ENSGRID_MEAN_06h_TN    "{{ vx_ensgrid_mean_06h_tn }}">
<!ENTITY VX_ENSGRID_PROB_06h_TN    "{{ vx_ensgrid_prob_06h_tn }}">
<!ENTITY VX_ENSGRID_MEAN_24h_TN    "{{ vx_ensgrid_mean_24h_tn }}">
<!ENTITY VX_ENSGRID_PROB_24h_TN    "{{ vx_ensgrid_prob_24h_tn }}">
<!ENTITY VX_ENSGRID_PROB_REFC_TN   "{{ vx_ensgrid_prob_refc_tn }}">
<!ENTITY VX_ENSGRID_PROB_RETOP_TN  "{{ vx_ensgrid_prob_retop_tn }}">
<!ENTITY VX_ENSPOINT_TN            "{{ vx_enspoint_tn }}">
<!ENTITY VX_ENSPOINT_MEAN_TN       "{{ vx_enspoint_mean_tn }}">
<!ENTITY VX_ENSPOINT_PROB_TN       "{{ vx_enspoint_prob_tn }}">
<!ENTITY PLOT_ALLVARS_TN           "{{ plot_allvars_tn }}">

<!--
Flags that specify whether to run the preprocessing and/or verification tasks.
-->
<!ENTITY RUN_TASK_MAKE_GRID      "{{ run_task_make_grid | upper }}">
<!ENTITY RUN_TASK_MAKE_OROG      "{{ run_task_make_orog | upper }}">
<!ENTITY RUN_TASK_MAKE_SFC_CLIMO "{{ run_task_make_sfc_climo | upper }}">

<!--
Number of physical cores per node for the current machine.  This is used
below in the <nodesize> tag, but that tag is not clearly documented.  This
parameter may be unnecessary since each task now has its own variable that
specifies the number of processes per node being used (the PPN_... entities).
-->
<!ENTITY NCORES_PER_NODE "{{ ncores_per_node }}">

<!--
Directories and files.
-->
<!ENTITY USHdir                   "{{ ushdir }}">
<!ENTITY JOBSdir                  "{{ jobsdir }}">
<!ENTITY SCRIPTSdir               "{{ scriptsdir }}">
<!ENTITY COMIN_BASEDIR            "{{ comin_basedir }}">
<!ENTITY COMOUT_BASEDIR           "{{ comout_basedir }}">
<!ENTITY GLOBAL_VAR_DEFNS_FP      "{{ global_var_defns_fp }}">
<!ENTITY LOAD_MODULES_RUN_TASK_FP "{{ load_modules_run_task_fp }}">
<!ENTITY EXPTDIR                  "{{ exptdir }}">

<!ENTITY OBSPATH                  "{{ obspath }}">
<!ENTITY NWGES_BASEDIR            "{{ nwges_basedir }}">
<!ENTITY ENSCTRL_COMIN_BASEDIR    "{{ ensctrl_comin_basedir }}">
<!ENTITY ENSCTRL_NWGES_BASEDIR    "{{ ensctrl_nwges_basedir }}">
<!ENTITY ENSCTRL_COMOUT_BASEDIR   "{{ ensctrl_comout_basedir }}">
<!ENTITY ENSCTRL_COMOUT_DIR       "{{ ensctrl_comout_dir }}">
<!ENTITY RRFSE_FG_ROOT            "{{ rrfse_nwges_basedir }}">
{%- if is_rtma %}
<!ENTITY FG_ROOT                  "{{ fg_rootdir }}">
{%- else %}
<!ENTITY FG_ROOT                  "{{ nwges_basedir }}">
{%- endif %}


{%- if run_envir == "nco"  %}
{%- if do_ensemble %}
<!ENTITY DYN_DIR  "{{ dataroot }}/run_fcst_{{ ensmem_indx_name }}#{{ ensmem_indx_name }}#.{{ workflow_id }}_<cyclestr>@Y@m@d@H</cyclestr>/dyn">
<!ENTITY PHY_DIR  "{{ dataroot }}/run_fcst_{{ ensmem_indx_name }}#{{ ensmem_indx_name }}#.{{ workflow_id }}_<cyclestr>@Y@m@d@H</cyclestr>/phy">
{%- else %}
<!ENTITY DYN_DIR  "{{ dataroot }}/run_fcst.{{ workflow_id }}_<cyclestr>@Y@m@d@H</cyclestr>/dyn">
<!ENTITY PHY_DIR  "{{ dataroot }}/run_fcst.{{ workflow_id }}_<cyclestr>@Y@m@d@H</cyclestr>/phy">
{%- endif %}
{%- else %}
<!ENTITY DYN_DIR  "{{ comout_basedir }}/<cyclestr>@Y@m@d@H</cyclestr>{{ slash_ensmem_subdir }}/dyn">
<!ENTITY PHY_DIR  "{{ comout_basedir }}/<cyclestr>@Y@m@d@H</cyclestr>{{ slash_ensmem_subdir }}/phy">
{%- endif %}

{%- if run_envir == "nco"  %}
<!ENTITY LOGDIR                   "{{ logbasedir }}/<cyclestr>@Y@m@d</cyclestr>">
<!ENTITY LOGEXT                   ".{{ workflow_id }}.log" >
{%- else %}
<!ENTITY LOGDIR                   "{{ logbasedir }}">
<!ENTITY LOGEXT                   ".log" >
{%- endif %}
<!ENTITY CMPEXT                   "_task_complete.txt">

<!ENTITY MET_INSTALL_DIR "{{ met_install_dir }}">
<!ENTITY METPLUS_PATH "{{ metplus_path }}">
<!ENTITY METPLUS_CONF "{{ metplus_conf }}">
<!ENTITY MET_CONFIG "{{ met_config }}">
<!ENTITY CCPA_OBS_DIR "{{ ccpa_obs_dir }}">
<!ENTITY MRMS_OBS_DIR "{{ mrms_obs_dir }}">
<!ENTITY NDAS_OBS_DIR "{{ ndas_obs_dir }}">

<!--
Reservation types.  Reservations specify the queue/partition and account
to use for a given task.  The "DEFAULT" reservation type is used for all 
tasks other than GET_EXTRN_ICS_TN, GET_EXTRN_LBCS_TN, and RUN_FCST_TN; 
the "HPSS" type is used for the GET_EXTRN_ICS_TN and GET_EXTRN_LBCS_TN 
tasks; and the "FCST" type is used for the RUN_FCST_TN task.
-->

{%- if partition_default is not none %}
<!ENTITY RSRV_DEFAULT "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue><partition>{{ partition_default }}</partition><native>&RRFS_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_DEFAULT "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue>">
{%- endif %}
{%- if partition_hpss is not none %}
<!ENTITY RSRV_HPSS    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_HPSS;</queue><partition>{{ partition_hpss }}</partition><native>&RRFS_POST_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_HPSS    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_HPSS;</queue>">
{%- endif %}
{%- if partition_fcst is not none %}
<!ENTITY RSRV_FCST    "<account>&ACCOUNT;</account><queue>&QUEUE_FCST;</queue><partition>{{ partition_fcst }}</partition>">
{%- else %}
<!ENTITY RSRV_FCST    "<account>&ACCOUNT;</account><queue>&QUEUE_FCST;</queue>">
{%- endif %}
{%- if partition_analysis is not none %}
<!ENTITY RSRV_ANALYSIS    "<account>&ACCOUNT;</account><queue>&QUEUE_ANALYSIS;</queue><partition>{{ partition_analysis }}</partition>">
<!ENTITY RSRV_ENKF    "<account>&ACCOUNT;</account><queue>&QUEUE_ANALYSIS;</queue><partition>{{ partition_analysis }}</partition><native>&RRFS_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_ANALYSIS    "<account>&ACCOUNT;</account><queue>&QUEUE_ANALYSIS;</queue>">
<!ENTITY RSRV_ENKF    "<account>&ACCOUNT;</account><queue>&QUEUE_ANALYSIS;</queue>">
{%- endif %}
{%- if partition_post is not none %}
<!ENTITY RSRV_POST    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_POST;</queue><partition>{{ partition_post }}</partition><native>&RRFS_POST_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_POST    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_POST;</queue>">
{%- endif %}
{%- if partition_prdgen is not none %}
<!ENTITY RSRV_PRDGEN    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_PRDGEN;</queue><partition>{{ partition_prdgen }}</partition><native>&RRFS_POST_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_PRDGEN    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_PRDGEN;</queue>">
{%- endif %}
{%- if partition_graphics is not none %}
{%- if do_ens_graphics %}
<!ENTITY RSRV_GRAPHICS   "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_GRAPHICS;</queue><partition>{{ partition_graphics }}</partition><native>&RRFS_POST_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_GRAPHICS   "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_GRAPHICS;</queue><partition>{{ partition_graphics }}</partition><native>&RRFS_POST_RESERVE;</native>">
{%- endif %}
{%- else %}
<!ENTITY RSRV_GRAPHICS   "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_GRAPHICS;</queue><native>--exclusive</native>">
{%- endif %}

<!-- FROM RRFS_dev1 -->
{% if do_retro %}
<!ENTITY DEADLINE_PRE      "999:00:00">
<!ENTITY DEADLINE_ANAL     "999:00:00">
<!ENTITY DEADLINE_FCST     "999:30:00">
<!ENTITY DEADLINE_POST     "999:00:00">
<!ENTITY DEADLINE_GRAPHICS "999:00:00">
<!ENTITY DEADLINE_RECENTER "999:00:00">
<!ENTITY DEADLINE_SAVE_RESTART "999:00:00">
{% else %}
<!ENTITY DEADLINE_PRE      "16:00:00">
<!ENTITY DEADLINE_ANAL     "16:00:00">
<!ENTITY DEADLINE_FCST     "23:30:00">
<!ENTITY DEADLINE_POST     "24:00:00">
<!ENTITY DEADLINE_GRAPHICS "24:00:00">
<!ENTITY DEADLINE_RECENTER "24:00:00">
<!ENTITY DEADLINE_SAVE_RESTART "24:00:00">
{% endif %}

<!ENTITY START_TIME_SPINUP "{{ start_time_spinup }}">
<!ENTITY START_TIME_PROD "{{ start_time_prod }}">
<!ENTITY START_TIME_CONVENTIONAL_SPINUP "{{ start_time_conventional_spinup }}">
<!ENTITY START_TIME_LATE_ANALYSIS "{{ start_time_late_analysis }}">
<!ENTITY START_TIME_CONVENTIONAL "{{ start_time_conventional }}">
<!ENTITY START_TIME_NSSLMOSIAC   "{{ start_time_nsslmosiac }}">
<!ENTITY START_TIME_LIGHTNINGNC  "{{ start_time_lightningnc }}">
<!ENTITY START_TIME_PROCSMOKE  "{{ start_time_procsmoke }}">

{%- if do_retro %}
<!ENTITY WALL_LIMIT_PRE ''>
<!ENTITY WALL_LIMIT_ANAL ''>
<!ENTITY WALL_LIMIT_FCST ''>
<!ENTITY WALL_LIMIT_POST ''>
<!ENTITY WALL_LIMIT_BUFR ''>
<!ENTITY WALL_LIMIT_GRAPHICS ''>
<!ENTITY WALL_LIMIT_RECENTER ''>
<!ENTITY WALL_LIMIT_SAVE_RESTART ''>
{% else %}
<!ENTITY WALL_LIMIT_PRE '<deadline><cyclestr offset="&DEADLINE_PRE;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_ANAL '<deadline><cyclestr offset="&DEADLINE_ANAL;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_FCST '<deadline><cyclestr offset="&DEADLINE_FCST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_POST '<deadline><cyclestr offset="&DEADLINE_POST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_BUFR '<deadline><cyclestr offset="&DEADLINE_POST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_BUFRSND '<deadline><cyclestr offset="&DEADLINE_POST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_GRAPHICS '<deadline><cyclestr offset="&DEADLINE_GRAPHICS;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_RECENTER '<deadline><cyclestr offset="&DEADLINE_RECENTER;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_SAVE_RESTART '<deadline><cyclestr offset="&DEADLINE_SAVE_RESTART;">@Y@m@d@H@M</cyclestr></deadline>'>
{% endif %}

<!ENTITY STARTYEAR  "{{ startyear }}">
<!ENTITY STARTMONTH "{{ startmonth }}">
<!ENTITY STARTDAY   "{{ startday }}">
<!ENTITY STARTHOUR  "{{ starthour }}">

<!ENTITY ENDYEAR  "{{ endyear }}">
<!ENTITY ENDMONTH "{{ endmonth }}">
<!ENTITY ENDDAY   "{{ endday }}">
<!ENTITY ENDHOUR  "{{ endhour }}">

]>

<!--
************************************************************************
************************************************************************
-->

{%- if do_retro %}
<workflow realtime="F" scheduler="&SCHED;" cyclethrottle="5" taskthrottle="{{ taskthrottle }}">
{% else %}
<workflow realtime="T" scheduler="&SCHED;" cyclethrottle="24" taskthrottle="{{ taskthrottle }}" cyclelifespan="01:00:00:00">
{%- endif %}
{# Double quotes are required inside the strftime! Expect an error from reading the template if using single quotes. #}

<!--
************************************************************************
************************************************************************
-->
{%- if not do_rrfs_dev %}
  <cycledef group="at_start">{{ cdate_first_cycl.strftime("%M %H %d %m %Y *") }}</cycledef>
  <cycledef group="initial">{{ cdate_first_cycl.strftime("%M %H %d %m %Y *") }}</cycledef>

  <cycledef group="boundary">{{- date_first_cycl ~ " " ~ date_last_cycl ~ " " ~ cycl_freq -}}</cycledef>
  <cycledef group="boundary_long">{{- date_first_cycl ~ " " ~ date_last_cycl ~ " " ~ cycl_freq -}}</cycledef>

  <cycledef group="spinupcyc">{{- date_first_cycl ~ " " ~ date_last_cycl ~ " " ~ cycl_freq -}}</cycledef>
  <cycledef group="prodcyc">{{- date_first_cycl ~ " " ~ date_last_cycl ~ " " ~ cycl_freq -}}</cycledef>
  <cycledef group="prodcyc_long">{{- date_first_cycl ~ " " ~ date_last_cycl ~ " " ~ cycl_freq -}}</cycledef>

{%- if do_save_input %}
  <cycledef group="saveinputcyc"> {{ date_first_cycl ~ " " ~ date_last_cycl ~ " " ~ cycl_freq }} </cycledef>
{%- endif %}
  <cycledef group="recentercyc"> {{ date_first_cycl ~ " " ~ date_last_cycl ~ " " ~ cycl_freq }} </cycledef>
  <cycledef group="archive">  {{ date_first_cycl ~ " " ~ date_last_cycl ~ " " ~ cycl_freq }} </cycledef> 

{%- else -%}
<!--
************************************************************************
************************************************************************
-->
  <cycledef group="at_start">{{ at_start_cycledef }} </cycledef>
  <cycledef group="initial"> {{ initial_cycledef }} </cycledef>
  <cycledef group="boundary"> {{ boundary_cycledef }} </cycledef>
  <cycledef group="boundary_long"> {{ boundary_long_cycledef }} </cycledef>

  <cycledef group="spinupcyc"> {{ spinup_cycledef }} </cycledef>
  <cycledef group="prodcyc"> {{ prod_cycledef }} </cycledef>
  <cycledef group="prodcyc_long"> {{ prodlong_cycledef }} </cycledef>

{%- if do_save_input %}
  <cycledef group="saveinputcyc"> {{ saveinput_cycledef }} </cycledef>
{%- endif %}
  <cycledef group="recentercyc"> {{ recenter_cycledef }} </cycledef>
  <cycledef group="archive">  {{ archive_cycledef }} </cycledef> 

{%- endif -%}
<!--
************************************************************************
************************************************************************
-->

  <log>
  {%- if run_envir == "nco"  %}
    &LOGDIR;/FV3LAM_wflow.{{ workflow_id }}.log
  {%- else %}
    &LOGDIR;/FV3LAM_wflow.log
  {%- endif %}
  </log>

<!-- 
The following command works to call the J-job for a given task (in this
case the MAKE_GRID_TN task) if in the script LOAD_MODULES_RUN_TASK_FP we 
do NOT call exec to run the J-job.  The command first sources the script
LOAD_MODULES_RUN_TASK_FP and then runs the J-job, so it is simpler than
calling exec and thus preferred if NCO accepts it.  Note that the portion
of the command that sources LOAD_MODULES_RUN_TASK_FP also passes an 
argument to it (the argument being the name of the task).  This works in
bash but it probably won't work in sh.

If this method is acceptable to NCO, then for clarity maybe we can
source LOAD_MODULES_RUN_TASK_FP within the J-job instead of here since
we are already sourcing other files in the J-job anyway.
-->
<!--
    <command>{ . &LOAD_MODULES_RUN_TASK_FP; "&MAKE_GRID_TN;";
               &JOBSdir;/JREGIONAL_MAKE_GRID;
             }</command>
-->
<!--
The following command works if we call exec in LOAD_MODULES_RUN_TASK_FP
to run the J-job.  This passes the J-job script as the second argument
to LOAD_MODULES_RUN_TASK_FP (the first argument is the task name).  The
J-job then uses exec to run the J-job (while also terminating the LOAD_-
MODULES_RUN_TASK_FP script.
-->

<!--
************************************************************************
************************************************************************
-->
{%- if run_task_make_grid %}
  <task name="&MAKE_GRID_TN;" cycledefs="at_start" maxtries="{{ maxtries_make_grid }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_GRID_TN;" "&JOBSdir;/JREGIONAL_MAKE_GRID"</command>
    <nodes>{{ nnodes_make_grid }}:ppn={{ ppn_make_grid }}</nodes>
    <walltime>{{ wtime_make_grid }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&MAKE_GRID_TN;</jobname>
    <join>&LOGDIR;/&MAKE_GRID_TN;&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_make_orog %}
  <task name="&MAKE_OROG_TN;" cycledefs="at_start" maxtries="{{ maxtries_make_orog }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_OROG_TN;" "&JOBSdir;/JREGIONAL_MAKE_OROG"</command>
    <nodes>{{ nnodes_make_orog }}:ppn={{ ppn_make_orog }}</nodes>
    <walltime>{{ wtime_make_orog }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&MAKE_OROG_TN;</jobname>
    <join>&LOGDIR;/&MAKE_OROG_TN;&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>

    <dependency>
      <or>
<!--        <taskdep task="make_grid"/> -->
        <datadep age="00:00:00:05">&EXPTDIR;/grid/&MAKE_GRID_TN;&CMPEXT;</datadep>
        <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
      </or>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_make_sfc_climo %}
  <task name="&MAKE_SFC_CLIMO_TN;" cycledefs="at_start" maxtries="{{ maxtries_make_sfc_climo }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_SFC_CLIMO_TN;" "&JOBSdir;/JREGIONAL_MAKE_SFC_CLIMO"</command>
    <nodes>{{ nnodes_make_sfc_climo }}:ppn={{ ppn_make_sfc_climo }}</nodes>
    <walltime>{{ wtime_make_sfc_climo }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&MAKE_SFC_CLIMO_TN;</jobname>
    <join>&LOGDIR;/&MAKE_SFC_CLIMO_TN;&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>

    <dependency>
      <and>
        <or>
<!--          <taskdep task="&MAKE_GRID_TN;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/grid/&MAKE_GRID_TN;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_OROG_TN;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/orog/&MAKE_OROG_TN;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if not do_ensfcst %}
{%- if do_rrfs_dev %}

<!-- beginning of meta block for prod spinup  -->
<metatask name="data_preprocessing">
  
{%- if do_spinup %}
  <var name="cycletype">spinupcyc prodcyc,prodcyc_long</var>
  <var name="type">spinup prod</var>
{% else %}
  <var name="cycletype">prodcyc,prodcyc_long</var>
  <var name="type">prod</var>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{%- if do_smoke_dust %}
  <task name="&PROCESS_SMOKE_TN;_#type#" cycledefs="#cycletype#"  maxtries="{{ maxtries_process_smoke }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_SMOKE_TN;" "&JOBSdir;/JREGIONAL_PROCESS_SMOKE"</command>

    <nodes>{{ nnodes_process_smoke }}:ppn={{ ppn_process_smoke }}</nodes>
    <walltime>{{ wtime_process_smoke }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_process_smoke }}</memory>
  {%- endif %}

    <jobname>&TAG;_&PROCESS_SMOKE_TN;_#type#</jobname>
    <join>&LOGDIR;/&PROCESS_SMOKE_TN;_#type#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>

    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>
    <envar><name>NWGES_BASEDIR</name><value>&NWGES_BASEDIR;</value></envar>
    <envar><name>NWGES_DIR</name><value>&NWGES_BASEDIR;</value></envar>

    <dependency>
      <and>
        <timedep><cyclestr offset="&START_TIME_PROCSMOKE;">@Y@m@d@H@M00</cyclestr></timedep>
      </and>
    </dependency>

  </task>
{%- endif %}

{%- if do_nonvar_cldanal or do_refl2tten or do_enkf_radar_ref or do_envar_radar_ref %}
<!--
************************************************************************
************************************************************************
--> 
  <task name="&PROCESS_RADAR_REF_TN;_#type#" cycledefs="#cycletype#"  maxtries="{{ maxtries_process_radarref }}">
    
    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSdir;/JREGIONAL_PROCESS_RADARREF"</command>
      
    <nodes>{{ nnodes_process_radarref }}:ppn={{ ppn_process_radarref }}</nodes>
    <walltime>{{ wtime_process_radarref }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname>&TAG;_&PROCESS_RADAR_REF_TN;_#type#</jobname>
    <join>&LOGDIR;/&PROCESS_RADAR_REF_TN;_#type#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>
        
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>

    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>
    <envar><name>RADAR_REF_THINNING</name><value>{{ radar_ref_thinning }}</value></envar>
    <envar><name>NWGES_BASEDIR</name><value>&NWGES_BASEDIR;</value></envar>
        
    <dependency>
      <and>
        <timedep><cyclestr offset="&START_TIME_NSSLMOSIAC;">@Y@m@d@H@M00</cyclestr></timedep>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
{%- if do_nldn_lght %}
  <task name="&PROCESS_LIGHTNING_TN;_#type#" cycledefs="#cycletype#"  maxtries="{{ maxtries_process_lightning }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSdir;/JREGIONAL_PROCESS_LIGHTNING"</command>

    <nodes>{{ nnodes_process_lightning }}:ppn={{ ppn_process_lightning }}</nodes>
    <walltime>{{ wtime_process_lightning }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname>&TAG;_&PROCESS_LIGHTNING_TN;_#type#</jobname>
    <join>&LOGDIR;/&PROCESS_LIGHTNING_TN;_#type#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>

    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>

    <dependency>
      <and>
        <timedep><cyclestr offset="&START_TIME_LIGHTNINGNC;">@Y@m@d@H@M00</cyclestr></timedep>
      </and>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&PROCESS_BUFR_TN;_#type#" cycledefs="#cycletype#"  maxtries="{{ maxtries_process_bufr }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSdir;/JREGIONAL_PROCESS_BUFR"</command>

    <nodes>{{ nnodes_process_bufr }}:ppn={{ ppn_process_bufr }}</nodes>
    <walltime>{{ wtime_process_bufr }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_process_bufr }}</memory>
  {%- endif %}
    <jobname>&TAG;_&PROCESS_BUFR_TN;_#type#</jobname>
    <join>&LOGDIR;/&PROCESS_BUFR_TN;_#type#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>

    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>

    <dependency>
      <and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
{%- endif %}
</metatask>
<!-- end of meta block for prod spinup  -->

{%- endif %}
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{% if not is_rtma %}

{%- if do_ensemble %}
 <metatask name="run_ensemble_pre">

  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}{%- set fmtstr=" %03d" -%}{{- fmtstr%m -}}{%- endfor %} </var>
  {%- if do_enscontrol %}
    <var name="subdirGE">/gec00{% for m in range(2, num_ens_members+1) %}{{ " /gep%02d"%m }}{% endfor %}</var>
    <var name="memNameWRF">_mem0000{% for m in range(2, num_ens_members+1) %}{{ " _mem%04d"%m }}{% endfor %} </var>
  {%- else %}
    <var name="subdirGE">{% for m in range(1, num_ens_members+1) %}{{ " /gep%02d"%m }}{% endfor %}</var>
    <var name="memNameWRF">{% for m in range(1, num_ens_members+1) %}{{ " _mem%04d"%m }}{% endfor %} </var>
    <var name="memNameGDAS">{% for m in range(1, num_ens_members+1) %}{{ " mem%03d"%m }}{% endfor %} </var>
  {%- endif %}
    <var name="subdirGDAS">{% for m in range(1, num_ens_members+1) %}{{ " /mem%03d"%m }}{% endfor %}</var>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{%- if run_task_get_extrn_ics %}

  <task name="&GET_EXTRN_ICS_TN;{{ uscore_ensmem_name }}" cycledefs="initial" maxtries="{{ maxtries_get_extrn_ics }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_EXTRN_ICS_TN;" "&JOBSdir;/JREGIONAL_GET_EXTRN_MDL_FILES"</command>

    <nodes>{{ nnodes_get_extrn_ics }}:ppn={{ ppn_get_extrn_ics }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_get_extrn_ics }}</memory>
  {%- endif %}
    <walltime>{{ wtime_get_extrn_ics }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- if machine not in ["WCOSS2"] %}
    <native>&SCHED_NATIVE_CMD;</native>
  {%- endif %}

    <jobname>&TAG;_&GET_EXTRN_ICS_TN;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&GET_EXTRN_ICS_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>ICS_OR_LBCS</name><value>ICS</value></envar>
    <envar><name>GEFS_INPUT_SUBDIR</name><value>#subdirGE#</value></envar>
    <envar><name>WRF_MEM_NAME</name><value>#memNameWRF#</value></envar>
    <envar><name>GDASENKF_INPUT_SUBDIR</name><value>#subdirGDAS#</value></envar>
    <envar><name>GDAS_MEM_NAME</name><value>#memNameGDAS#</value></envar>

    <dependency>
      <and>
      <true></true>      

      {%- if machine in ["WCOSS2"]  %}
      {%- if fv3gfs_file_fmt_ics in ["netcdf"] %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.atmf{{ "%03d" % extrn_mdl_ics_offset_hrs }}.nc</cyclestr></datadep>
      {% else %}
      {%- if extrn_mdl_name_ics in ["GEFS"] %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/gefs.@Y@m@d/@H/atmos/pgrb2bp5/#subdirGE#.t@Hz.pgrb2b.0p50.f{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
      {% else %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.pgrb2.0p25.f{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
      {%- endif %}
      {%- endif %}
      {%- elif machine in ["ORION"]  %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
      {% else %}
      {%- if extrn_mdl_name_ics in ["GEFS"] %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/#subdirGE#/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
      {%- elif extrn_mdl_name_ics in ["GDASENKF"] %}
      <and>
      {%- if machine in ["HERA"] %}
        <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.atmf00{{ extrn_mdl_ics_offset_hrs }}.nc</cyclestr></datadep>
        <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.sfcf00{{ extrn_mdl_ics_offset_hrs }}.nc</cyclestr></datadep>
      {%- elif machine in ["JET"] %}
        <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H00.gdas.t@Hz.atmf00{{ extrn_mdl_ics_offset_hrs }}.#memNameGDAS#.nc</cyclestr></datadep>
        <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H00.gdas.t@Hz.sfcf00{{ extrn_mdl_ics_offset_hrs }}.#memNameGDAS#.nc</cyclestr></datadep>
      {%- endif %}
      </and>
      {%- elif extrn_mdl_name_ics in ["HRRRDAS"] %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@Y@m@d@H/postprd#memNameWRF#/wrfnat#memNameWRF#_00.grib2</cyclestr></datadep>
      {%- else %}
      {%- if machine in ["JET"] %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
      {%- elif machine in ["HERA"] %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
      {%- endif %}
      {%- endif %}
      {%- endif %}
      </and>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_get_extrn_lbcs %}

  <task name="&GET_EXTRN_LBCS_TN;{{ uscore_ensmem_name }}" cycledefs="boundary" maxtries="{{ maxtries_get_extrn_lbcs }}">

    &WALL_LIMIT_PRE;
    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_EXTRN_LBCS_TN;" "&JOBSdir;/JREGIONAL_GET_EXTRN_MDL_FILES"</command>

    <nodes>{{ nnodes_get_extrn_lbcs }}:ppn={{ ppn_get_extrn_lbcs }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_get_extrn_lbcs }}</memory>
  {%- endif %}
    <walltime>{{ wtime_get_extrn_lbcs }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- if machine not in ["WCOSS2"] %}
    <native>&SCHED_NATIVE_CMD;</native>
  {%- endif %}

    <jobname>&TAG;_&GET_EXTRN_LBCS_TN;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&GET_EXTRN_LBCS_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>EXTRN_MDL_NAME</name><value>{{ extrn_mdl_name_lbcs }}</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>LBCS</value></envar>
    <envar><name>BOUNDARY_LEN</name><value>{{ boundary_len_hrs }}</value></envar>
    <envar><name>GEFS_INPUT_SUBDIR</name><value>#subdirGE#</value></envar>
    <envar><name>GDASENKF_INPUT_SUBDIR</name><value>#subdirGDAS#</value></envar>
    <envar><name>GDAS_MEM_NAME</name><value>#memNameGDAS#</value></envar>

    <dependency>
       <and>
         <true></true>
         {%- for h in range(extrn_mdl_lbcs_offset_hrs, boundary_len_hrs+extrn_mdl_lbcs_offset_hrs+1, lbc_spec_intvl_hrs) %}
         {%- if machine in ["WCOSS2"]  %}
         {%- if fv3gfs_file_fmt_lbcs in ["netcdf"]  %}
         <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.atmf{{ "%03d" % h }}.nc</cyclestr></datadep>
         {%- else %}
         <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.pgrb2.0p25.f{{ "%03d" % h }}</cyclestr></datadep>
         {%- endif %}
         {%- elif machine in ["ORION"]  %}
         {%- if fv3gfs_file_fmt_lbcs in ["netcdf"]  %}
         <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.atmf{{ "%03d" % h }}.nc</cyclestr></datadep>
         {%- else %}
         <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.pgrb2.0p25.f{{ "%03d" % h }}</cyclestr></datadep>
         {%- endif %}
         {%- elif machine in ["ORION"]  %}
         <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
         {%- else %}
         {%- if extrn_mdl_name_lbcs in ["GEFS"] %}
         <datadep age="00:00:05:00"> <cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/#subdirGE#/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
         {%- elif extrn_mdl_name_lbcs in ["GDASENKF"] %}
         {%- if machine in ["HERA"] %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.atmf{{ "%03d" % h }}.nc</cyclestr></datadep>
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.sfcf{{ "%03d" % h }}.nc</cyclestr></datadep>
         {%- elif machine in ["JET"] %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H00.gdas.t@Hz.atmf{{ "%03d" % h }}.#memNameGDAS#.nc</cyclestr></datadep>
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H00.gdas.t@Hz.sfcf{{ "%03d" % h }}.#memNameGDAS#.nc</cyclestr></datadep>
         {%- endif %}
         {%- else %}
         {%- if machine in ["JET"] %}
         <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
         {%- elif machine in ["HERA"] %}
         <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
         {%- endif %}
         {%- endif %}
         {%- endif %}
         {%- endfor %}
       </and>
    </dependency>

  </task>

{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_get_extrn_lbcs %}

  <task name="&GET_EXTRN_LBCS_LONG_TN;{{ uscore_ensmem_name }}" cycledefs="boundary_long" maxtries="{{ maxtries_get_extrn_lbcs }}">

    &WALL_LIMIT_PRE;
    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_EXTRN_LBCS_TN;" "&JOBSdir;/JREGIONAL_GET_EXTRN_MDL_FILES"</command>

    <nodes>{{ nnodes_get_extrn_lbcs }}:ppn={{ ppn_get_extrn_lbcs }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_get_extrn_lbcs }}</memory>
  {%- endif %}
    <walltime>{{ wtime_get_extrn_lbcs }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- if machine not in ["WCOSS2"] %}
    <native>&SCHED_NATIVE_CMD;</native>
  {%- endif %}

    <jobname>&TAG;_&GET_EXTRN_LBCS_LONG_TN;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&GET_EXTRN_LBCS_LONG_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>EXTRN_MDL_NAME</name><value>{{ extrn_mdl_name_lbcs }}</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>LBCS</value></envar>
    <envar><name>BOUNDARY_LEN</name><value>{{ boundary_len_hrs }}</value></envar>
    <envar><name>GEFS_INPUT_SUBDIR</name><value>#subdirGE#</value></envar>
    <envar><name>GDASENKF_INPUT_SUBDIR</name><value>#subdirGDAS#</value></envar>
    <envar><name>GDAS_MEM_NAME</name><value>#memNameGDAS#</value></envar>

    <dependency>
       <and>
         <true></true>
         {%- for h in range(extrn_mdl_lbcs_offset_hrs, boundary_long_len_hrs+extrn_mdl_lbcs_offset_hrs+1, lbc_spec_intvl_hrs) %}
         {%- if machine in ["WCOSS2"] %}
         <datadep age="00:00:05:00"><cyclestr>{{ extrn_mdl_sysbasedir_lbcs }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.pgrb2.0p25.f{{ "%03d" % h }}</cyclestr></datadep>
         {%- elif machine in ["ORION"]  %}
         <datadep age="00:00:05:00"><cyclestr>{{ extrn_mdl_sysbasedir_lbcs }}/gdas.@Y@m@d/@H/atmos/gdas.t@Hz.atmf{{ "%03d" % h }}.nc</cyclestr></datadep>
         {%- else %}
         {%- if extrn_mdl_name_lbcs in ["GEFS"] %}
         <datadep age="00:00:05:00"> <cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/#subdirGE#/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
         {%- else %}
         <datadep age="00:00:05:00"> <cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
         {%- endif %}
         {%- endif %}
         {%- endfor %}
       </and>
    </dependency>

  </task>

{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_make_ics %}
  <task name="&MAKE_ICS_TN;{{ uscore_ensmem_name }}" cycledefs="initial" maxtries="{{ maxtries_make_ics }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_ICS_TN;" "&JOBSdir;/JREGIONAL_MAKE_ICS"</command>
    <nodes>{{ nnodes_make_ics }}:ppn={{ ppn_make_ics }}</nodes>
    <walltime>{{ wtime_make_ics }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&TAG;&MAKE_ICS_TN;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&MAKE_ICS_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&GET_EXTRN_ICS_TN;"/>
        <or>
<!--          <taskdep task="&MAKE_GRID_TN;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/grid/&MAKE_GRID_TN;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_OROG_TN;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/orog/&MAKE_OROG_TN;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_SFC_CLIMO_TN;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/sfc_climo/&MAKE_SFC_CLIMO_TN;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_make_lbcs %}
<metatask name="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}">
  <var name="bcgrp">{% for h in range(0, boundary_proc_group_num) %}{{ " %02d" % h  }}{% endfor %}</var>

  <task name="&MAKE_LBCS_TN;_#bcgrp#{{ uscore_ensmem_name }}" cycledefs="boundary,boundary_long" maxtries="{{ maxtries_make_lbcs }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_LBCS_TN;" "&JOBSdir;/JREGIONAL_MAKE_LBCS"</command>
    <nodes>{{ nnodes_make_lbcs }}:ppn={{ ppn_make_lbcs }}</nodes>
    <walltime>{{ wtime_make_lbcs }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&TAG;&MAKE_LBCS_TN;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&MAKE_LBCS_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H_#bcgrp#</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>bcgrp</name><value>#bcgrp#</value></envar>
    <envar><name>bcgrpnum</name><value>{{ boundary_proc_group_num }}</value></envar>

    <dependency>
      <and>
        <or>
          <taskdep task="&GET_EXTRN_LBCS_TN;{{ uscore_ensmem_name }}"/>
          <taskdep task="&GET_EXTRN_LBCS_LONG_TN;{{ uscore_ensmem_name }}"/>
        </or>
        <or>
<!--          <taskdep task="&MAKE_GRID_TN;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/grid/&MAKE_GRID_TN;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_OROG_TN;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/orog/&MAKE_OROG_TN;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_SFC_CLIMO_TN;"/> -->
          <datadep age="00:00:00:05">&EXPTDIR;/sfc_climo/&MAKE_SFC_CLIMO_TN;&CMPEXT;</datadep>
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
</metatask>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->

{% if do_ensemble %}
</metatask>
{% endif %}

{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if not do_ensfcst %}

<!-- beginning of spinup block  -->
{%- if do_spinup %}

{%- if do_ensemble %}
 <metatask name="run_ensemble">
  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}{%- set fmtstr=" %03d" -%}{{- fmtstr%m -}}{%- endfor %} </var>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
  <task name="&PREP_CYC_SPINUP_TN;{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_run_prepstart }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_PREPSTART_TN;" "&JOBSdir;/JREGIONAL_RUN_PREPSTART"</command>

    <nodes>{{ nnodes_run_prepstart }}:ppn={{ ppn_run_prepstart }}</nodes>
    <walltime>{{ wtime_run_prepstart }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname>&TAG;_&PREP_CYC_SPINUP_TN;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&PREP_CYC_SPINUP_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>FG_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>LBCS_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
 {%- if do_ensinit %}
    <envar><name>CYCLE_SUBTYPE</name><value><cyclestr>ensinit</cyclestr></value></envar>
 {%- endif %}
    <envar><name>NWGES_BASEDIR</name><value>&NWGES_BASEDIR;</value></envar>

    <dependency>
       <or>
<!-- for start spin up cycle -->
         <and>
           <or>
             {%- for h in cycl_hrs_spinstart %}
             <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
           </or>
           <taskdep task="&MAKE_ICS_TN;{{ uscore_ensmem_name }}"/>
           <or>
             {%- for h in range(0,lbcs_search_hrs) %} 
             <metataskdep metatask="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}" cycle_offset="-{{ h }}:00:00"/>
             {%- endfor %}
           </or>
{%- if do_retro %}
  {%- if not do_ensemble %}
           <datadep age="00:00:10:00"><cyclestr offset="00:00:00">&FG_ROOT;/@Y@m@d@H/{{ slash_ensmem_subdir }}/fcst_fv3lam/INPUT/gfs_ctrl.nc</cyclestr></datadep>
  {%- endif %}
{%- else %}
           <timedep><cyclestr offset="&START_TIME_SPINUP;">@Y@m@d@H@M00</cyclestr></timedep>
{%- endif %}
         </and>
<!-- for continue spin up cycles  -->
         <and>
           {%- for h in cycl_hrs_spinstart %}
           <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
           {%- endfor %}
{%- if do_retro %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interv }}:00:00">&FG_ROOT;/@Y@m@d@H/{{ slash_ensmem_subdir }}/fcst_fv3lam_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
{%- else %}
           <timedep><cyclestr offset="&START_TIME_CONVENTIONAL_SPINUP;">@Y@m@d@H@M00</cyclestr></timedep>
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interv }}:00:00">&FG_ROOT;/@Y@m@d@H/{{ slash_ensmem_subdir }}/fcst_fv3lam_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
{%- endif %}
         </and>
       </or>
    </dependency>

  </task>

{% if do_ensinit -%}
<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_FCST_TN;_ensinit{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_run_fcst }}">

    &RSRV_FCST;
    &WALL_LIMIT_FCST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_FCST_TN;" "&JOBSdir;/JREGIONAL_RUN_FCST"</command>

  {%- if machine in ["JET", "HERA", "LINUX"]  %}
    <cores>{{ ncores_run_fcst }}</cores>
    <native>{{ native_run_fcst }} &RRFS_RESERVE;</native>
  {%- elif machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}:tpp={{ omp_num_threads_run_fcst }}</nodes>
    <native>&SCHED_NATIVE_CMD;</native>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- else %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- endif %}
    <native>&SCHED_NATIVE_CMD;</native>
    <walltime>{{ wtime_run_fcst }}</walltime>

    <jobname>&TAG;_&RUN_FCST_TN;_ensinit{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&RUN_FCST_TN;_ensinit{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>CYCLE_SUBTYPE</name><value><cyclestr>ensinit</cyclestr></value></envar>
    <envar><name>NWGES_BASEDIR</name><value>&NWGES_BASEDIR;</value></envar>
    <envar><name>RESTART_HRS</name><value><cyclestr>0</cyclestr></value></envar>

    <dependency>
        <and>   
          <or>    
           {%- for h in cycl_hrs_spinstart %}
            <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
           {%- endfor %}
          </or>   
          <taskdep task="&PREP_CYC_SPINUP_TN;{{ uscore_ensmem_name }}"/>
        </and>  
    </dependency>

  </task> 
<!--
************************************************************************
************************************************************************
-->
    <task name="&SAVE_RESTART_TN;_ensinit{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_save_restart }}">

      &RSRV_DEFAULT;
      &WALL_LIMIT_SAVE_RESTART;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&SAVE_RESTART_TN;" "&JOBSdir;/JREGIONAL_SAVE_RESTART"</command>

      <nodes>{{ nnodes_save_restart }}:ppn={{ ppn_save_restart }}</nodes>
      <walltime>{{ wtime_save_restart }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <native>&SCHED_NATIVE_CMD;</native>

      <jobname>&TAG;_&SAVE_RESTART_TN;_ensinit{{ uscore_ensmem_name }}</jobname>
      <join>&LOGDIR;/&SAVE_RESTART_TN;_ensinit{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>0</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
      <envar><name>CYCLE_SUBTYPE</name><value><cyclestr>ensinit</cyclestr></value></envar>

      <dependency>
        <and>
          <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
          <datadep age="01:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam_ensinit/RESTART/coupler.res</cyclestr></datadep>
        </and>
      </dependency>

    </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&PREP_CYC_SPINUP_TN;_ensinit{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_run_prepstart }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_PREPSTART_TN;" "&JOBSdir;/JREGIONAL_RUN_PREPSTART"</command>

    <nodes>{{ nnodes_run_prepstart }}:ppn={{ ppn_run_prepstart }}</nodes>
    <walltime>{{ wtime_run_prepstart }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname>&TAG;_&PREP_CYC_SPINUP_TN;_ensinit{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&PREP_CYC_SPINUP_TN;_ensinit{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>FG_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>LBCS_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>CYCLE_SUBTYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>NWGES_BASEDIR</name><value>&NWGES_BASEDIR;</value></envar>

    <dependency>
       <taskdep task="&SAVE_RESTART_TN;_ensinit{{ uscore_ensmem_name }}"/>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_RECENTER_TN;_spinup" cycledefs="spinupcyc" maxtries="{{ maxtries_run_recenter }}">
    &RSRV_ENKF;
    &WALL_LIMIT_RECENTER;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_RECENTER_TN;" &JOBSdir;/JREGIONAL_RUN_RECENTER</command>

    <nodes>{{ nnodes_run_recenter }}:ppn={{ ppn_run_recenter }}</nodes>
    <walltime>{{ wtime_run_recenter }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname><cyclestr>&TAG;_&RUN_RECENTER_TN;_spinup</cyclestr></jobname>
    <join>&LOGDIR;/&RUN_RECENTER_TN;_spinup<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>ENSCTRL_COMIN_DIR</name><value><cyclestr>&ENSCTRL_COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>ENSCTRL_COMIN_ROOT</name><value><cyclestr>&ENSCTRL_COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>

    <dependency>
      <and>
        {%- for m in range(1, num_ens_members+1) %}
          <taskdep task="&PREP_CYC_SPINUP_TN;_ensinit_mem{{ "%04d" % m }}"/>
        {%- endfor %}
        <datadep age="00:00:00:05"><cyclestr>&ENSCTRL_COMIN_BASEDIR;/@Y@m@d@H/nonvar_cldanl_spinup/nonvarcldanl_complete.txt</cyclestr></datadep>
      </and>
    </dependency>
  </task>
{%- endif %}

{%- if not do_ensemble %}
{%- if do_dacycle %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ANAL_GSI_TN;_spinup{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_run_anal }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSdir;/JREGIONAL_RUN_ANAL"</command>

  {%- if machine in ["JET", "HERA", "LINUX"]  %}
    <cores>{{ ncores_run_anal }}</cores>
    <native>&SHED_NATIVE_CMD; &RRFS_RESERVE;</native>
  {%- elif machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}:tpp={{ omp_num_threads_run_anal }}</nodes>
    <native>&SCHED_NATIVE_CMD;</native>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- else %}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- endif %}
    <native>&SCHED_NATIVE_CMD;</native>
    <walltime>{{ wtime_run_anal }}</walltime>

    <jobname>&TAG;_&ANAL_GSI_TN;_spinup{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&ANAL_GSI_TN;{{ uscore_ensmem_name }}_spinup<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>RRFSE_FG_ROOT</name><value><cyclestr>&RRFSE_FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&NWGES_BASEDIR;/satbias</cyclestr></value></envar>
    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>

    <dependency>
       <and>
         <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
         <taskdep task="&PREP_CYC_TN;_spinup{{ uscore_ensmem_name }}"/>
         {%- if use_rrfse_ens %}
         <or>
           <and>
             <or>
             {%- for h in cycl_hrs_hyb_fv3lam_ens %}
               <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
             </or>
             <or>
               <and> 
                 <or>
             {%- for h in cycl_hrs_prodstart_ens %}
               <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
                 </or>
             {% for h in range(1, num_ens_members+1) %}
             <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interv }}:00:00">&RRFSE_FG_ROOT;/@Y@m@d@H/mem{{ "%04d" % h  }}/fcst_fv3lam_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             {%- endfor %}
               </and>
               <and> 
                 <or>
             {%- for h in cycl_hrs_prodstart_ens %}
               <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
             {%- endfor %}
                 </or>
             {% for h in range(1, num_ens_members+1) %}
             <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interv }}:00:00">&RRFSE_FG_ROOT;/@Y@m@d@H/mem{{ "%04d" % h  }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             {%- endfor %}
               </and>
             </or>
           </and>
           <and>
              {%- for h in cycl_hrs_hyb_fv3lam_ens %}
                <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
              {%- endfor %}
           </and>
         </or>
         {%- endif %}
       </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&POSTANAL_TN;_spinup{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_run_postanal }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_POST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSdir;/JREGIONAL_RUN_POSTANAL"</command>

    <nodes>{{ nnodes_run_postanal }}:ppn={{ ppn_run_postanal }}</nodes>
    <walltime>{{ wtime_run_postanal }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname>&TAG;_&POSTANAL_TN;_spinup{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&POSTANAL_TN;{{ uscore_ensmem_name }}_spinup_<cyclestr>@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>RRFSE_FG_ROOT</name><value><cyclestr>&RRFSE_FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&NWGES_BASEDIR;/satbias</cyclestr></value></envar>
    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>

    <dependency>
       <taskdep task="&ANAL_GSI_TN;_spinup{{ uscore_ensmem_name }}"/>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->
{%- if do_envar_radar_ref %}
  <task name="&HYBRID_RADAR_REF_TN;_spinup" cycledefs="spinupcyc" maxtries="{{ maxtries_run_anal }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&HYBRID_RADAR_REF_TN;" "&JOBSdir;/JREGIONAL_RUN_ANAL"</command>

  {%- if machine in ["JET", "HERA", "LINUX"]  %}
    <cores>{{ ncores_run_anal }}</cores>
    <native>&SHED_NATIVE_CMD; &RRFS_RESERVE;</native>
  {%- elif machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}:tpp={{ omp_num_threads_run_anal }}</nodes>
    <native>&SCHED_NATIVE_CMD;</native>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- else %}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- endif %}
    <native>&SCHED_NATIVE_CMD;</native>
    <walltime>{{ wtime_run_anal }}</walltime>

    <jobname>&TAG;_&HYBRID_RADAR_REF_TN;_spinup</jobname>
    <join>&LOGDIR;/&HYBRID_RADAR_REF_TN;_spinup<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>RRFSE_FG_ROOT</name><value><cyclestr>&RRFSE_FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&NWGES_BASEDIR;/satbias</cyclestr></value></envar>
    <envar><name>nens</name><value>30</value></envar>
    <envar><name>OB_TYPE</name><value>radardbz</value></envar>

    <dependency>
       <and>
         <taskdep task="&ANAL_GSI_TN;_spinup"/>
         <or>    
            {%- for h in cycl_hrs_hyb_fv3lam_ens %}
               <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
            {%- endfor %}
         </or>   
       </and>
    </dependency>

  </task>
{% endif -%}
<!--
************************************************************************
************************************************************************
-->

{% endif -%}

<!--
************************************************************************
************************************************************************
-->
{%- if do_refl2tten %}
  <task name="&RADAR_REFL2TTEN_TN;_spinup" cycledefs="spinupcyc"  maxtries="{{ maxtries_run_ref2tten }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSdir;/JREGIONAL_REFL2TTEN"</command>

    <nodes>{{ nnodes_run_ref2tten }}:ppn={{ ppn_run_ref2tten }}</nodes>
    <walltime>{{ wtime_run_ref2tten }}</walltime>
    <memory>{{ mem_run_ref2tten }}</memory>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname>&TAG;_&RADAR_REFL2TTEN_TN;_spinup</jobname>
    <join>&LOGDIR;/&RADAR_REFL2TTEN_TN;_spinup<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>

    <dependency>
      <and>
        <or>
          <taskdep task="&PROCESS_RADAR_REF_TN;_spinup"/>
          <taskdep task="&PROCESS_BUFR_TN;_spinup"/>
        </or>
        <taskdep task="&ANAL_GSI_TN;_spinup"/>
      </and>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if do_jedi_envar_ioda %}
  <task name="&JEDI_ENVAR_IODA_TN;_spinup{{ uscore_ensmem_name }}" cycledefs="spinupcyc"  maxtries="{{ maxtries_run_jedi_envar_ioda }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "jedienvar_ioda" "&JOBSdir;/JREGIONAL_JEDIENVAR_IODA"</command>

    <nodes>{{ nnodes_run_jedi_envar_ioda }}:ppn={{ ppn_run_jedi_envar_ioda }}</nodes>
    <walltime>{{ wtime_run_jedi_envar_ioda }}</walltime>
    <memory>{{ mem_run_jedi_envar_ioda }}</memory>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname>&TAG;_&JEDI_ENVAR_IODA_TN;_spinup</jobname>
    <join>&LOGDIR;/&JEDI_ENVAR_IODA_TN;_spinup<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&ANAL_GSI_TN;_spinup"/>
      </and>
    </dependency>

  </task>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{%- if do_nonvar_cldanal %}
  <task name="&CLDANL_NONVAR_TN;_spinup{{ uscore_ensmem_name }}" cycledefs="spinupcyc"  maxtries="{{ maxtries_run_nonvarcldanl }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSdir;/JREGIONAL_NONVARCLD"</command>

    <nodes>{{ nnodes_run_nonvarcldanl }}:ppn={{ ppn_run_nonvarcldanl }}</nodes>
    <walltime>{{ wtime_run_nonvarcldanl }}</walltime>
    <memory>{{ mem_run_nonvarcldanl }}</memory>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname>&TAG;_&CLDANL_NONVAR_TN;_spinup{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&CLDANL_NONVAR_TN;_spinup{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&PROCESS_BUFR_TN;_spinup"/>
        {%- if do_enkfupdate %}
        <and>
           {%- if do_enkf_radar_ref %}
             <taskdep task="&ENKF_RADAR_REF_TN;"/>
           {%- else %}
             <taskdep task="&RUN_ENKFUPDT_TN;"/>
           {%- endif %}
        </and>
        {%- elif do_envar_radar_ref %}
        <or>
          <and>
            <taskdep task="&POSTANAL_TN;_spinup{{ uscore_ensmem_name }}"/>
             {%- for h in cycl_hrs_hyb_fv3lam_ens %}
                <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
             {%- endfor %}
          </and>
          <and>
        <taskdep task="&HYBRID_RADAR_REF_TN;_spinup"/>
            <or>    
             {%- for h in cycl_hrs_hyb_fv3lam_ens %}
                <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
            </or>   
          </and>
        </or>
        {%- else %}
    <taskdep task="&POSTANAL_TN;_spinup{{ uscore_ensmem_name }}"/>
        {%- endif %}
      </and>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_FCST_TN;_spinup{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_run_fcst }}">

    &RSRV_FCST;
    &WALL_LIMIT_FCST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_FCST_TN;" "&JOBSdir;/JREGIONAL_RUN_FCST"</command>

  {%- if machine in ["JET", "HERA", "LINUX"]  %}
    <cores>{{ ncores_run_fcst }}</cores>
    <native>{{ native_run_fcst }} &RRFS_RESERVE;</native>
  {%- elif machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}:tpp={{ omp_num_threads_run_fcst }}</nodes>
    <native>&SCHED_NATIVE_CMD;</native>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- else %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- endif %}
    <native>&SCHED_NATIVE_CMD;</native>
    <walltime>{{ wtime_run_fcst }}</walltime>

    <jobname>&TAG;_&RUN_FCST_TN;_spinup{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&RUN_FCST_TN;_spinup{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>NWGES_BASEDIR</name><value>&NWGES_BASEDIR;</value></envar>
    <envar><name>RESTART_HRS</name><value><cyclestr>1</cyclestr></value></envar>
  
    <dependency>
      {%- if do_dacycle and do_refl2tten and do_nonvar_cldanal%}
      <and>
        <taskdep task="&RADAR_REFL2TTEN_TN;_spinup"/>
        <taskdep task="&CLDANL_NONVAR_TN;_spinup"/>
      </and>
      {%- elif do_dacycle and do_nonvar_cldanal%}
      <taskdep task="&CLDANL_NONVAR_TN;_spinup"/>
      {%- elif do_dacycle and do_refl2tten%}
      <taskdep task="&RADAR_REFL2TTEN_TN;_spinup"/>
      {%- elif do_dacycle %}
        {%- if do_envar_radar_ref %}
        <taskdep task="&HYBRID_RADAR_REF_TN;_spinup"/>
        {%- else  %}
        <taskdep task="&POSTANAL_TN;_spinup{{ uscore_ensmem_name }}"/>
        {%- endif %}
      {%- elif do_enkfupdate or do_enkf_radar_ref %}
        <and>
          <or>
          {%- for h in cycl_hrs_spinstart %}
            <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
          {%- endfor %}
          </or>
          <or>
          {%- if do_ensinit %}
          <taskdep task="&RUN_RECENTER_TN;_spinup"/>
          {%- else  %}
          <taskdep task="&PREP_CYC_TN;_spinup{{ uscore_ensmem_name }}"/>
          {%- endif %}
          </or>
        </and>
      {%- else %}
      <taskdep task="&PREP_CYC_TN;_spinup{{ uscore_ensmem_name }}"/>
      {%- endif %}
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <metatask name="&SAVE_RESTART_TN;_spinup">

    <var name="fhr"> {% for h in range(da_cycle_interv, fcst_len_hrs_spinup+da_cycle_interv, da_cycle_interv) %}{{ " %03d" % h  }}{% endfor %} </var>

    <task name="&SAVE_RESTART_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#" cycledefs="spinupcyc" maxtries="{{ maxtries_save_restart }}">

      &RSRV_DEFAULT;
      &WALL_LIMIT_SAVE_RESTART;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&SAVE_RESTART_TN;" "&JOBSdir;/JREGIONAL_SAVE_RESTART"</command>

      <nodes>{{ nnodes_save_restart }}:ppn={{ ppn_save_restart }}</nodes>
      <walltime>{{ wtime_save_restart }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <native>&SCHED_NATIVE_CMD;</native>

      <jobname>&TAG;_&SAVE_RESTART_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join>&LOGDIR;/&SAVE_RESTART_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>

      <dependency>
        <and>
          <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
          <or>
            <datadep age="01:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam_spinup/RESTART/coupler.res</cyclestr></datadep>
            <datadep age="01:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam_spinup/RESTART/</cyclestr><cyclestr offset="#fhr#:00:00">@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          </or>
        </and>
      </dependency>

    </task>

  </metatask>

<!--
************************************************************************
************************************************************************
-->
{% if do_post_spinup %}
  <metatask name="&RUN_POST_TN;_spinup{{ uscore_ensmem_name }}">

    <var name="fhr"> {% for h in range(0, fcst_len_hrs_spinup+1) %}{{ " %03d" % h  }}{% endfor %} </var>
<!--
************************************************************************
************************************************************************
-->
    <task name="&RUN_POST_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#" cycledefs="spinupcyc" maxtries="{{ maxtries_run_post }}">

      &RSRV_POST;
      &WALL_LIMIT_POST;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSdir;/JREGIONAL_RUN_POST"</command>

      <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
      <walltime>{{ wtime_run_post }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <native>&SCHED_NATIVE_CMD;</native>

      <jobname>&TAG;_&RUN_POST_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join>&LOGDIR;/&RUN_POST_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
      <envar><name>TMMARK</name><value>tm00</value></envar>

      <dependency>
        <datadep age="02:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam_spinup/logf#fhr#</cyclestr></datadep>
      </dependency>

    </task>
<!--
************************************************************************
************************************************************************
-->
    <task name="&RUN_PRDGEN_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#" cycledefs="spinupcyc" maxtries="{{ maxtries_run_prdgen }}">

      &RSRV_PRDGEN;
      &WALL_LIMIT_POST;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_PRDGEN_TN;" "&JOBSdir;/JREGIONAL_RUN_PRDGEN"</command>

      <nodes>{{ nnodes_run_prdgen }}:ppn={{ ppn_run_prdgen }}</nodes>
      <walltime>{{ wtime_run_prdgen }}</walltime>
      <memory>{{ mem_run_prdgen }}</memory>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <native>&SCHED_NATIVE_CMD;</native>

      <jobname>&TAG;_&RUN_PRDGEN_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join>&LOGDIR;/&RUN_PRDGEN_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
      <envar><name>TMMARK</name><value>tm00</value></envar>

      <dependency>
        <taskdep task="&RUN_POST_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#"/>
      </dependency>

    </task>
<!--
************************************************************************
************************************************************************
-->
  </metatask>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->

{%- if do_ensemble %}
</metatask>
{%- endif %}

<!-- end of spinup block -->
{%- endif %}


{%- endif %}  <!-- not do_ensfcst -->

<!--
************************************************************************
************************************************************************
-->

<!-- beginning of prod block -->
{%- if do_rrfs_dev %}

{%- if do_ensemble %}
 <metatask name="run_ensemble">
  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}{%- set fmtstr=" %03d" -%}{{- fmtstr%m -}}{%- endfor %} </var>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
  <task name="&PREP_CYC_PROD_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_prepstart }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_PREPSTART_TN;" "&JOBSdir;/JREGIONAL_RUN_PREPSTART"</command>

    <nodes>{{ nnodes_run_prepstart }}:ppn={{ ppn_run_prepstart }}</nodes>
    <walltime>{{ wtime_run_prepstart }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname>&TAG;_&PREP_CYC_PROD_TN;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&PREP_CYC_PROD_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>FG_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>LBCS_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>NWGES_BASEDIR</name><value>&NWGES_BASEDIR;</value></envar>

    <dependency>
     {%- if do_ensfcst %}
       <and>
         <datadep age="00:00:05:00"><cyclestr>&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/DA_OUTPUT/coupler.res</cyclestr></datadep>
         <metataskdep metatask="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}"/>
       </and>
     {%- else %}
       <or>
<!-- for start product cycle -->
         <and>
           <or>
             {%- for h in cycl_hrs_prodstart %}
             <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
           </or>
{%- if do_spinup %}
{%- if do_retro %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interv }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
{% else %}
           <or>
             <and>
               <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
               <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interv }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             </and>
             <and>
               <timedep><cyclestr offset="&START_TIME_PROD;">@Y@m@d@H@M00</cyclestr></timedep>
               <or>
                 {%- for h in range(da_cycle_interv, 6+1, da_cycle_interv) %}
                 <datadep age="00:00:01:00"><cyclestr offset="-{{ h }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
                 {%- endfor %}
               </or>
             </and>
           </or>
{%- endif %}
{% else %}
{%- if do_retro %}
           <and>
             <datadep age="00:00:05:00"><cyclestr>&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/ics/gfs_data.tile7.halo0.nc</cyclestr></datadep>
             <or>
             {%- for h in range(0, extrn_mdl_ics_offset_hrs+1) %}
             <datadep age="00:00:05:00"><cyclestr offset="-{{ h }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/lbcs/gfs_bndy.tile7.{{ "%03d" % boundary_len_hrs }}.nc</cyclestr></datadep>
             {%- endfor %}
             </or>
           </and>
{% else %}
           <and>
             <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
             <taskdep task="&MAKE_ICS_TN;{{ uscore_ensmem_name }}"/>
             <or>
               <metataskdep metatask="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}"/>
               <metataskdep metatask="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}" cycle_offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00"/>
             </or>
           </and>
{%- endif %}
{%- endif %}
         </and>
<!-- for continue product cycles  -->
         <and>
           {%- for h in cycl_hrs_prodstart %}
           <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
           {%- endfor %}
{%- if do_retro %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interv }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
{% else %}
           <or>
             <and>
               <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
               <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interv }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             </and>
             <and>
               <timedep><cyclestr offset="&START_TIME_LATE_ANALYSIS;">@Y@m@d@H@M00</cyclestr></timedep>
               <or>
                 {%- for h in range(da_cycle_interv+da_cycle_interv, 6+1, da_cycle_interv) %}
                 <datadep age="00:00:01:00"><cyclestr offset="-{{ h }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
                 {%- endfor %}
               </or>
             </and>
           </or>
{%- endif %}
         </and>
       </or>
{%- endif %}
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->

{%- if do_ensemble %}
</metatask>
{%- endif %}
{%- endif %}

{%- if not do_ensfcst %}
{%- if do_gsiobserver %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&CALC_ENSMEAN_TN;" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_prepstart }}">

    &RSRV_ENKF;
    &WALL_LIMIT_RECENTER;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_PREPSTART_TN;" "&JOBSdir;/JREGIONAL_CALC_ENSMEAN"</command>

    <nodes>{{ nnodes_run_recenter }}:ppn={{ ppn_run_recenter }}</nodes>
    <walltime>{{ wtime_run_recenter }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname>&TAG;_&CALC_ENSMEAN_TN;</jobname>
    <join>&LOGDIR;/&CALC_ENSMEAN_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>

    <dependency>
         <and>
         {%- for m in range(1, num_ens_members+1) %}
         <taskdep task="&PREP_CYC_PROD_TN;_mem{{ "%04d" % m }}"/>
         {%- endfor %}
         </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&OBSERVER_GSI_ENSMEAN_TN;" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_anal }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSdir;/JREGIONAL_RUN_ANAL"</command>

  {%- if machine in ["JET", "HERA", "LINUX"]  %}
    <cores>{{ ncores_run_anal }}</cores>
    <native>&SHED_NATIVE_CMD; &RRFS_RESERVE;</native>
  {%- elif machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}:tpp={{ omp_num_threads_run_anal }}</nodes>
    <native>&SCHED_NATIVE_CMD;</native>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- else %}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- endif %}
    <native>&SCHED_NATIVE_CMD;</native>
    <walltime>{{ wtime_run_anal }}</walltime>

    <jobname>&TAG;_&OBSERVER_GSI_ENSMEAN_TN;</jobname>
    <join>&LOGDIR;/&OBSERVER_GSI_ENSMEAN_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>OBSERVER</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEAN</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&NWGES_BASEDIR;/satbias</cyclestr></value></envar>

    <dependency>
       <and>
         <taskdep task="&CALC_ENSMEAN_TN;"/>
         {%- if do_enkf_radar_ref %}
         <taskdep task="&PROCESS_RADAR_REF_TN;_prod"/>
         {%- endif %}
         {% if machine in ["JET", "HERA"] -%}
         <datadep age="05:00"><cyclestr>&OBSPATH;/@Y@m@d@H.rap.t@Hz.prepbufr.tm00</cyclestr></datadep>
         {% else -%}
     <datadep age="05:00"><cyclestr>&OBSPATH;/rap.@Y@m@d/rap.t@Hz.prepbufr.tm00</cyclestr></datadep>
         {% endif -%}
       </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
 {%- if do_ensemble %}
 <metatask name="run_ensemble_observer">
   <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}
    {%- set fmtstr=" %03d" -%}
    {{- fmtstr%m -}}
   {%- endfor %} </var>
 {%- endif %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&OBSERVER_GSI_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_anal }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSdir;/JREGIONAL_RUN_ANAL"</command>

  {%- if machine in ["JET", "HERA", "LINUX"]  %}
    <cores>{{ ncores_run_anal }}</cores>
    <native>&SHED_NATIVE_CMD; &RRFS_RESERVE;</native>
  {%- elif machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}:tpp={{ omp_num_threads_run_anal }}</nodes>
    <native>&SCHED_NATIVE_CMD;</native>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- else %}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- endif %}
    <native>&SCHED_NATIVE_CMD;</native>
    <walltime>{{ wtime_run_anal }}</walltime>

    <jobname>&TAG;_&OBSERVER_GSI_TN;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&OBSERVER_GSI_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>OBSERVER</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&NWGES_BASEDIR;/satbias</cyclestr></value></envar>

    <dependency>
       <and>
         <taskdep task="&OBSERVER_GSI_ENSMEAN_TN;"/>
       </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->

{%- if do_ensemble %}
  </metatask>
{%- endif %}
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{%- if do_enkfupdate %}
  <task name="&RUN_ENKFUPDT_TN;" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_enkf }}">
    &RSRV_ENKF;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ENKFUPDT_TN;" &JOBSdir;/JREGIONAL_RUN_ENKF</command>

    <nodes>{{ nnodes_run_enkf }}:ppn={{ ppn_run_enkf }}</nodes>
    <walltime>{{ wtime_run_enkf }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname><cyclestr>&TAG;_&RUN_ENKFUPDT_TN;</cyclestr></jobname>
    <join>&LOGDIR;/&RUN_ENKFUPDT_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>OB_TYPE</name><value>conv</value></envar>

    <dependency>
        <metataskdep metatask="run_ensemble_observer"/>
    </dependency>
  </task>

{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{%- if do_enkf_radar_ref %}
  <task name="&ENKF_RADAR_REF_TN;" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_enkf }}">
    &RSRV_ENKF;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ENKF_RADAR_REF_TN;" &JOBSdir;/JREGIONAL_RUN_ENKF</command>

    <nodes>{{ nnodes_run_enkf }}:ppn={{ ppn_run_enkf }}</nodes>
    <walltime>{{ wtime_run_enkf }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname><cyclestr>&TAG;_&ENKF_RADAR_REF_TN;</cyclestr></jobname>
    <join>&LOGDIR;/&ENKF_RADAR_REF_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>OB_TYPE</name><value>radardbz</value></envar>

    <dependency>
      <and>
        <taskdep task="&RUN_ENKFUPDT_TN;"/>
        {%- if do_retro %}
        <and> 
        {%- for m in range(1, num_ens_members+1) %}
          <datadep age="00:00:00:01"><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H/mem{{ "%04d" % m }}/observer_gsi/diag_conv_rw_ges.@Y@m@d@H.nc4</cyclestr></datadep>
        {%- endfor %}
        </and> 
        {%- endif %}
      </and>
    </dependency>
  </task>

{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if do_recenter %}
  <task name="&RUN_RECENTER_TN;" cycledefs="recentercyc" maxtries="{{ maxtries_run_recenter }}">
    &RSRV_ENKF;
    &WALL_LIMIT_RECENTER;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_RECENTER_TN;" &JOBSdir;/JREGIONAL_RUN_RECENTER</command>

    <nodes>{{ nnodes_run_recenter }}:ppn={{ ppn_run_recenter }}</nodes>
    <walltime>{{ wtime_run_recenter }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname><cyclestr>&TAG;_&RUN_RECENTER_TN;</cyclestr></jobname>
    <join>&LOGDIR;/&RUN_RECENTER_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>ENSCTRL_CYCLE_DIR</name><value><cyclestr>&ENSCTRL_COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>ENSCTRL_CYCLE_ROOT</name><value><cyclestr>&ENSCTRL_COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>

    <dependency>
      <and>
        {%- if do_nonvar_cldanal %}
        <and>
        {%- for m in range(1, num_ens_members+1) %}
          <taskdep task="&CLDANL_NONVAR_TN;_prod_mem{{ "%04d" % m }}"/>
        {%- endfor %}
        </and>
        {%- elif do_enkf_radar_ref %}
        <taskdep task="&ENKF_RADAR_REF_TN;"/>
        {%- elif do_enkfupdate %}
        <taskdep task="&RUN_ENKFUPDT_TN;"/>
        {%- endif %}
        <or>
        <datadep age="00:00:00:05"><cyclestr>&ENSCTRL_COMIN_BASEDIR;/@Y@m@d@H/nonvar_cldanl/nonvarcldanl_complete.txt</cyclestr></datadep>
        <datadep age="00:00:00:05"><cyclestr>&ENSCTRL_COMIN_BASEDIR;/@Y@m@d@H/nonvar_cldanl_spinup/nonvarcldanl_complete.txt</cyclestr></datadep>
        </or>
      </and>
    </dependency>
  </task>

{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{% if do_rrfs_dev %}
{% if do_ensemble %}
 <metatask name="run_ensemble">
  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}{%- set fmtstr=" %03d" -%}{{- fmtstr%m -}}{%- endfor %} </var>
{%- endif %}

{%- if do_dacycle %}

<!--
************************************************************************
************************************************************************
-->
  <task name="&ANAL_GSI_TN;_prod{{ uscore_ensmem_name }}" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_anal }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSdir;/JREGIONAL_RUN_ANAL"</command>

  {%- if machine in ["JET", "HERA", "LINUX"]  %}
    <cores>{{ ncores_run_anal }}</cores>
    <native>&SHED_NATIVE_CMD; &RRFS_RESERVE;</native>
  {%- elif machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}:tpp={{ omp_num_threads_run_anal }}</nodes>
    <native>&SCHED_NATIVE_CMD;</native>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- else %}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- endif %}
    <native>&SCHED_NATIVE_CMD;</native>
    <walltime>{{ wtime_run_anal }}</walltime>

    <jobname>&TAG;_&ANAL_GSI_TN;_prod{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&ANAL_GSI_TN;{{ uscore_ensmem_name }}_prod_<cyclestr>@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>RRFSE_FG_ROOT</name><value><cyclestr>&RRFSE_FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&NWGES_BASEDIR;/satbias</cyclestr></value></envar>
    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>

    <dependency>
       <and>
         <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
         <taskdep task="&PREP_CYC_TN;_prod{{ uscore_ensmem_name }}"/>
         {%- if use_rrfse_ens %}
         <or>
           <and>
             <or>
             {%- for h in cycl_hrs_hyb_fv3lam_ens %}
               <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
             </or>
           <or>
           {%- if do_spinup %}
            <and> 
             <or>
             {%- for h in cycl_hrs_prodstart_ens %}
               <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
             </or>
             {% for h in range(1, num_ens_members+1) %}
             <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interv }}:00:00">&RRFSE_FG_ROOT;/@Y@m@d@H/mem{{ "%04d" % h  }}/fcst_fv3lam_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             {%- endfor %}
            </and>
            <and> 
             <or>
             {%- for h in cycl_hrs_prodstart_ens %}
               <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
             {%- endfor %}
             </or>
             {% for h in range(1, num_ens_members+1) %}
             <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interv }}:00:00">&RRFSE_FG_ROOT;/@Y@m@d@H/mem{{ "%04d" % h  }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             {%- endfor %}
            </and>
           {%- else %} 
            <and>
             {% for h in range(1, num_ens_members+1) %}
             <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interv }}:00:00">&RRFSE_FG_ROOT;/@Y@m@d@H/mem{{ "%04d" % h  }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             {%- endfor %}
            </and>
           {%- endif %} 
           </or>
           </and>
           <and>
              {%- for h in cycl_hrs_hyb_fv3lam_ens %}
                <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
              {%- endfor %}
           </and>
         </or>
         {%- endif %}
       </and>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->
  <task name="&POSTANAL_TN;_prod{{ uscore_ensmem_name }}" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_postanal }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_POST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSdir;/JREGIONAL_RUN_POSTANAL"</command>

    <nodes>{{ nnodes_run_postanal }}:ppn={{ ppn_run_postanal }}</nodes>
    <walltime>{{ wtime_run_postanal }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname>&TAG;_&POSTANAL_TN;_prod{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&POSTANAL_TN;{{ uscore_ensmem_name }}_prod<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>RRFSE_FG_ROOT</name><value><cyclestr>&RRFSE_FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&NWGES_BASEDIR;/satbias</cyclestr></value></envar>
    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>

    <dependency>
       <taskdep task="&ANAL_GSI_TN;_prod{{ uscore_ensmem_name }}"/>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->
{%- if do_envar_radar_ref %}
  <task name="&HYBRID_RADAR_REF_TN;_prod" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_anal }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&HYBRID_RADAR_REF_TN;" "&JOBSdir;/JREGIONAL_RUN_ANAL"</command>

  {%- if machine in ["JET", "HERA", "LINUX"]  %}
    <cores>{{ ncores_run_anal }}</cores>
    <native>&SHED_NATIVE_CMD; &RRFS_RESERVE;</native>
  {%- elif machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}:tpp={{ omp_num_threads_run_anal }}</nodes>
    <native>&SCHED_NATIVE_CMD;</native>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- else %}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- endif %}
    <native>&SCHED_NATIVE_CMD;</native>
    <walltime>{{ wtime_run_anal }}</walltime>

    <jobname>&TAG;_&HYBRID_RADAR_REF_TN;_prod</jobname>
    <join>&LOGDIR;/&HYBRID_RADAR_REF_TN;_prod_<cyclestr>@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&COMIN_BASEDIR;</cyclestr></value></envar>
    <envar><name>RRFSE_FG_ROOT</name><value><cyclestr>&RRFSE_FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&NWGES_BASEDIR;/satbias</cyclestr></value></envar>
    <envar><name>nens</name><value>30</value></envar>
    <envar><name>OB_TYPE</name><value>radardbz</value></envar>

    <dependency>
       <and>
         <taskdep task="&ANAL_GSI_TN;_prod"/>
         <or>    
            {%- for h in cycl_hrs_hyb_fv3lam_ens %}
               <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
            {%- endfor %}
         </or>   
       </and>
    </dependency>

  </task>
{% endif -%}

<!--
************************************************************************
************************************************************************
-->

{% endif -%}

<!--
************************************************************************
************************************************************************
-->
{%- if do_refl2tten %}
  <task name="&RADAR_REFL2TTEN_TN;_prod" cycledefs="prodcyc,prodcyc_long"  maxtries="{{ maxtries_run_ref2tten }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSdir;/JREGIONAL_REFL2TTEN"</command>

    <nodes>{{ nnodes_run_ref2tten }}:ppn={{ ppn_run_ref2tten }}</nodes>
    <walltime>{{ wtime_run_ref2tten }}</walltime>
    <memory>{{ mem_run_ref2tten }}</memory>
    <nodesize>&NCORES_PER_NODE;</nodesize>

    <jobname>&TAG;_&RADAR_REFL2TTEN_TN;_prod</jobname>
    <join>&LOGDIR;/&RADAR_REFL2TTEN_TN;_prod_<cyclestr>@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>

    <dependency>
      <and>
        <or>
          <taskdep task="&PROCESS_RADAR_REF_TN;_prod"/>
          <taskdep task="&PROCESS_BUFR_TN;_prod"/>
        </or>
        <taskdep task="&ANAL_GSI_TN;_prod"/>
      </and>
    </dependency>

  </task>

{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{%- if do_jedi_envar_ioda %}
  <task name="&JEDI_ENVAR_IODA_TN;_prod{{ uscore_ensmem_name }}" cycledefs="prodcyc,prodcyc_long"  maxtries="{{ maxtries_run_jedi_envar_ioda }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "jedienvar_ioda" "&JOBSdir;/JREGIONAL_JEDIENVAR_IODA"</command>

    <nodes>{{ nnodes_run_jedi_envar_ioda }}:ppn={{ ppn_run_jedi_envar_ioda }}</nodes>
    <walltime>{{ wtime_run_jedi_envar_ioda }}</walltime>
    <memory>{{ mem_run_jedi_envar_ioda }}</memory>
    <nodesize>&NCORES_PER_NODE;</nodesize>

    <jobname>&TAG;_&JEDI_ENVAR_IODA_TN;_prod</jobname>
    <join>&LOGDIR;/&JEDI_ENVAR_IODA_TN;_prod_<cyclestr>@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&ANAL_GSI_TN;_prod"/>
      </and>
    </dependency>

  </task>

{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{%- if do_nonvar_cldanal %}
  <task name="&CLDANL_NONVAR_TN;_prod{{ uscore_ensmem_name }}" cycledefs="prodcyc,prodcyc_long"  maxtries="{{ maxtries_run_nonvarcldanl }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSdir;/JREGIONAL_NONVARCLD"</command>

    <nodes>{{ nnodes_run_nonvarcldanl }}:ppn={{ ppn_run_nonvarcldanl }}</nodes>
    <walltime>{{ wtime_run_nonvarcldanl }}</walltime>
    <memory>{{ mem_run_nonvarcldanl }}</memory>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>

    <jobname>&TAG;_&CLDANL_NONVAR_TN;_prod{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&CLDANL_NONVAR_TN;_prod{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&PROCESS_BUFR_TN;_prod"/>
        {%- if do_enkfupdate %}
        <and>
           {%- if do_enkf_radar_ref %}
             <taskdep task="&ENKF_RADAR_REF_TN;"/>
           {%- else %}
             <taskdep task="&RUN_ENKFUPDT_TN;"/>
           {%- endif %}
        </and>
        {%- elif do_envar_radar_ref %}
        <or>
          <and>
            <taskdep task="&POSTANAL_TN;_prod{{ uscore_ensmem_name }}"/>
             {%- for h in cycl_hrs_hyb_fv3lam_ens %}
                <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
             {%- endfor %}
          </and>
          <and>
        <taskdep task="&HYBRID_RADAR_REF_TN;_prod"/>
            <or>    
             {%- for h in cycl_hrs_hyb_fv3lam_ens %}
                <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
            </or>   
          </and>
        </or>
        {%- else %}
    <taskdep task="&POSTANAL_TN;_prod{{ uscore_ensmem_name }}"/>
        {%- endif %}
      </and>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->

{%- if do_ensemble %}
 </metatask>
{%- endif %}
{%- endif %}
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{%- if do_save_input and do_ensemble %}
 <metatask name="save_ensda_output">
  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members_fcst+1) -%}{%- set fmtstr=" %03d" -%}{{- fmtstr%m -}}{%- endfor %} </var>

  <task name="&SAVE_INPUT_TN;_prod{{ uscore_ensmem_name }}" cycledefs="saveinputcyc" maxtries="{{ maxtries_save_input }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_SAVE_RESTART;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&SAVE_RESTART_TN;" "&JOBSdir;/JREGIONAL_SAVE_INPUT"</command>

    <nodes>{{ nnodes_save_restart }}:ppn={{ ppn_save_restart }}</nodes>
    <walltime>{{ wtime_save_restart }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>

    <jobname>&TAG;_&SAVE_INPUT_TN;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&SAVE_INPUT_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>

    <dependency>
       {%- if do_recenter %}
        <or>
         <and>
          <or>
          {%- for h in cycl_hrs_recenter %}
          <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
          {%- endfor %}
          </or>
          <datadep age="01:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H/recenter/fcst_fv3lam/INPUT/recenter_complete.txt</cyclestr></datadep>
         </and>
         <and>
          {%- for h in cycl_hrs_recenter %}
          <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
          {%- endfor %}
          <taskdep task="&CLDANL_NONVAR_TN;_prod{{ uscore_ensmem_name }}"/>
         </and>
        </or>
        {%- elif do_nonvar_cldanal%}
        <taskdep task="&CLDANL_NONVAR_TN;_prod{{ uscore_ensmem_name }}"/>
        {%- elif do_enkf_radar_ref %}
        <taskdep task="&ENKF_RADAR_REF_TN;"/>
        {%- elif do_enkfupdate %}
        <taskdep task="&RUN_ENKFUPDT_TN;"/>
       {%- endif %}
    </dependency>

  </task>
 </metatask>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{% if do_ensemble %}
 <metatask name="run_ensemble">
  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}{%- set fmtstr=" %03d" -%}{{- fmtstr%m -}}{%- endfor %} </var>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_FCST_TN;_prod{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_run_fcst }}">

    &RSRV_FCST;
    &WALL_LIMIT_FCST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_FCST_TN;" "&JOBSdir;/JREGIONAL_RUN_FCST"</command>

  {%- if machine in ["JET", "HERA", "LINUX"]  %}
    <cores>{{ ncores_run_fcst }}</cores>
    <native>{{ native_run_fcst }} &RRFS_RESERVE;</native>
  {%- elif machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}:tpp={{ omp_num_threads_run_fcst }}</nodes>
    <native>&SCHED_NATIVE_CMD;</native>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- else %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- endif %}
    <native>&SCHED_NATIVE_CMD;</native>
    <walltime>{{ wtime_run_fcst }}</walltime>

    <jobname>&TAG;_&RUN_FCST_TN;_prod{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&RUN_FCST_TN;_prod{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>NWGES_BASEDIR</name><value>&NWGES_BASEDIR;</value></envar>
    <envar><name>RESTART_HRS</name><value><cyclestr>{{ restart_interval }}</cyclestr></value></envar>
  
    <dependency>
      {%- if do_ensfcst %}
      <taskdep task="&PREP_CYC_TN;_prod{{ uscore_ensmem_name }}"/>
      {%- elif do_dacycle and do_refl2tten and do_nonvar_cldanal%}
      <and>
        <taskdep task="&RADAR_REFL2TTEN_TN;_prod"/>
        <taskdep task="&CLDANL_NONVAR_TN;_prod"/>
      </and>
      {%- elif do_dacycle and do_nonvar_cldanal%}
      <taskdep task="&CLDANL_NONVAR_TN;_prod"/>
      {%- elif do_dacycle and do_refl2tten%}
      <taskdep task="&RADAR_REFL2TTEN_TN;_prod"/>
      {%- elif do_dacycle %}
        {%- if do_envar_radar_ref %}
        <taskdep task="&HYBRID_RADAR_REF_TN;_prod"/>
        {%- else  %}
        <taskdep task="&POSTANAL_TN;_prod"/>
        {%- endif %}
      {%- elif do_enkfupdate or do_enkf_radar_ref %}
        {%- if do_recenter %}
        <or>
         <and>
          <or>
          {%- for h in cycl_hrs_recenter %}
          <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
          {%- endfor %}
          </or>
          <datadep age="01:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H/recenter/fcst_fv3lam/INPUT/recenter_complete.txt</cyclestr></datadep>
         </and>
         <and>
          {%- for h in cycl_hrs_recenter %}
          <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
          {%- endfor %}
          <taskdep task="&CLDANL_NONVAR_TN;_prod{{ uscore_ensmem_name }}"/>
         </and>
        </or>
        {%- elif do_nonvar_cldanal%}
        <taskdep task="&CLDANL_NONVAR_TN;_prod{{ uscore_ensmem_name }}"/>
        {%- elif do_enkf_radar_ref %}
        <taskdep task="&ENKF_RADAR_REF_TN;"/>
        {%- else %}
        <taskdep task="&RUN_ENKFUPDT_TN;"/>
       {%- endif %}
      {%- else %}
      {%- if do_rrfs_dev %}
         <taskdep task="&PREP_CYC_TN;_prod{{ uscore_ensmem_name }}"/>
      {%- else %}
         <and>
           <taskdep task="&MAKE_ICS_TN;{{ uscore_ensmem_name }}"/>
           <taskdep task="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}"/>
         </and>
      {%- endif %}

      {%- endif %}
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_FCST_TN;_prod_long{{ uscore_ensmem_name }}" cycledefs="prodcyc_long" maxtries="{{ maxtries_run_fcst }}">

    &RSRV_FCST;
    &WALL_LIMIT_FCST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_FCST_TN;" "&JOBSdir;/JREGIONAL_RUN_FCST"</command>

  {%- if machine in ["JET", "HERA", "LINUX"]  %}
    <cores>{{ ncores_run_fcst }}</cores>
    <native>{{ native_run_fcst }} &RRFS_RESERVE;</native>
  {%- elif machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}:tpp={{ omp_num_threads_run_fcst }}</nodes>
    <native>&SCHED_NATIVE_CMD;</native>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- else %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- endif %}
    <native>&SCHED_NATIVE_CMD;</native>
    <walltime>{{ wtime_run_fcst_long }}</walltime>

    <jobname>&TAG;_&RUN_FCST_TN;_prod{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&RUN_FCST_TN;_prod{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>NWGES_BASEDIR</name><value>&NWGES_BASEDIR;</value></envar>
    <envar><name>RESTART_HRS</name><value><cyclestr>{{ restart_interval_long }}</cyclestr></value></envar>
  
    <dependency>
      {%- if do_dacycle and do_refl2tten and do_nonvar_cldanal%}
      <and>
        <taskdep task="&RADAR_REFL2TTEN_TN;_prod"/>
        <taskdep task="&CLDANL_NONVAR_TN;_prod"/>
      </and>
      {%- elif do_dacycle and do_nonvar_cldanal%}
      <taskdep task="&CLDANL_NONVAR_TN;_prod"/>
      {%- elif do_dacycle and do_refl2tten%}
      <taskdep task="&RADAR_REFL2TTEN_TN;_prod"/>
      {%- elif do_dacycle %}
        {%- if do_envar_radar_ref %}
        <taskdep task="&HYBRID_RADAR_REF_TN;_prod"/>
        {%- else  %}
        <taskdep task="&POSTANAL_TN;_prod"/>
        {%- endif %}
      {%- elif do_enkfupdate or do_enkf_radar_ref %}
        {%- if do_recenter %}
        <or>
         <and>
          <or>
          {%- for h in cycl_hrs_recenter %}
          <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
          {%- endfor %}
          </or>
          <datadep age="01:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H/recenter/fcst_fv3lam/INPUT/recenter_complete.txt</cyclestr></datadep>
         </and>
         <and>
          {%- for h in cycl_hrs_recenter %}
          <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
          {%- endfor %}
          <taskdep task="&CLDANL_NONVAR_TN;_prod{{ uscore_ensmem_name }}"/>
         </and>
        </or>
        {%- elif do_nonvar_cldanal%}
        <taskdep task="&CLDANL_NONVAR_TN;_prod{{ uscore_ensmem_name }}"/>
        {%- elif do_enkf_radar_ref %}
        <taskdep task="&ENKF_RADAR_REF_TN;"/>
        {%- else %}
        <taskdep task="&RUN_ENKFUPDT_TN;"/>
       {%- endif %}
      {%- else %}
      <taskdep task="&PREP_CYC_TN;_prod{{ uscore_ensmem_name }}"/>
      {%- endif %}
    </dependency>
  </task>
<!--
************************************************************************
************************************************************************
-->
{%- if not do_ensfcst %}
{%- if not is_rtma %}
{%- if do_rrfs_dev %}
  <metatask name="&SAVE_RESTART_TN;_prod">

    <var name="fhr"> {% for i in restart_interval %}{{ i }} {% endfor %} </var>

    <task name="&SAVE_RESTART_TN;_prod{{ uscore_ensmem_name }}_f#fhr#" cycledefs="prodcyc" maxtries="{{ maxtries_save_restart }}">

      &RSRV_DEFAULT;
      &WALL_LIMIT_SAVE_RESTART;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&SAVE_RESTART_TN;" "&JOBSdir;/JREGIONAL_SAVE_RESTART"</command>

      <nodes>{{ nnodes_save_restart }}:ppn={{ ppn_save_restart }}</nodes>
      <walltime>{{ wtime_save_restart }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>

      <jobname>&TAG;_&SAVE_RESTART_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join>&LOGDIR;/&SAVE_RESTART_TN;{{ uscore_ensmem_name }}_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>

      <dependency>
        <and>
          <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
          <or>
            <datadep age="01:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/RESTART/coupler.res</cyclestr></datadep>
            <datadep age="01:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr offset="#fhr#:00:00">@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          </or>
        </and>
      </dependency>

    </task>

  </metatask>

  <metatask name="&SAVE_RESTART_TN;_prod_long">

    <var name="fhr"> {% for i in restart_interval_long %}{{ i }} {% endfor %} </var>

    <task name="&SAVE_RESTART_TN;_prod_long{{ uscore_ensmem_name }}_f#fhr#" cycledefs="prodcyc_long" maxtries="{{ maxtries_save_restart }}">

      &RSRV_DEFAULT;
      &WALL_LIMIT_SAVE_RESTART;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&SAVE_RESTART_TN;" "&JOBSdir;/JREGIONAL_SAVE_RESTART"</command>

      <nodes>{{ nnodes_save_restart }}:ppn={{ ppn_save_restart }}</nodes>
      <walltime>{{ wtime_save_restart }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>

      <jobname>&TAG;_&SAVE_RESTART_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join>&LOGDIR;/&SAVE_RESTART_TN;{{ uscore_ensmem_name }}_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>

      <dependency>
        <and>
          <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
          <or>
            <datadep age="01:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/RESTART/coupler.res</cyclestr></datadep>
            <datadep age="01:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr offset="#fhr#:00:00">@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          </or>
        </and>
      </dependency>

    </task>

  </metatask>
{%- endif %}
{%- endif %}
{%- endif %}
<!--
************************************************************************
************************************************************************
-->

{%- if do_post_prod %}
<!--
************************************************************************
************************************************************************
-->
  <metatask name="&RUN_POST_TN;{{ uscore_ensmem_name }}">

    <var name="fullfhr"> {% for h in range(0, postproc_len_hrs+1) %}{{ " %03d" % h  }}{% endfor %} </var>
    <metatask>
{% if nsout_min > 0 %}
       <var name="fhr"> {% for h in range(0, 60, nsout_min) %}{{ " #fullfhr#-%02d-00 " % h  }}{% endfor %} </var>
{%- else %}
       <var name="fhr"> #fullfhr# </var>
{%- endif %}

    <task name="&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#" cycledefs="prodcyc" maxtries="{{ maxtries_run_post }}">

      &RSRV_POST;
      &WALL_LIMIT_POST;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSdir;/JREGIONAL_RUN_POST"</command>

      <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
      <walltime>{{ wtime_run_post }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <native>&SCHED_NATIVE_CMD;</native>

      <jobname>&TAG;_&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join>&LOGDIR;/&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>TMMARK</name><value>tm00</value></envar>

      <dependency>
          <datadep age="01:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/logf#fhr#</cyclestr></datadep>
      </dependency>

    </task>
  </metatask>
  </metatask>
<!--
************************************************************************
************************************************************************
-->
  <metatask name="&RUN_POST_TN;{{ uscore_ensmem_name }}_long">

    <var name="fullfhr"> {% for h in range(0, postproc_long_len_hrs+1) %}{{ " %03d" % h  }}{% endfor %} </var>
    <metatask>
{% if nsout_min > 0 %}
       <var name="fhr"> {% for h in range(0, 60, nsout_min) %}{{ " #fullfhr#-%02d-00 " % h  }}{% endfor %} </var>
{%- else %}
       <var name="fhr"> #fullfhr# </var>
{%- endif %}

    <task name="&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#_long" cycledefs="prodcyc_long" maxtries="{{ maxtries_run_post }}">

      &RSRV_POST;
      &WALL_LIMIT_POST;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSdir;/JREGIONAL_RUN_POST"</command>

      <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
      <walltime>{{ wtime_run_post }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <native>&SCHED_NATIVE_CMD;</native>

      <jobname>&TAG;_&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join>&LOGDIR;/&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>TMMARK</name><value>tm00</value></envar>

      <dependency>
         <datadep age="01:30"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/logf#fhr#</cyclestr></datadep>
      </dependency>

    </task>
  </metatask>
  </metatask>
<!--
************************************************************************
************************************************************************
-->
<metatask name="&RUN_PRDGEN_TN;{{ uscore_ensmem_name }}">

    <var name="fhr"> {% for h in range(0, postproc_len_hrs+1) %}{{ " %03d" % h  }}{% endfor %} </var>

    <task name="&RUN_PRDGEN_TN;{{ uscore_ensmem_name }}_f#fhr#" cycledefs="prodcyc" maxtries="{{ maxtries_run_prdgen }}">

      &RSRV_PRDGEN;
      &WALL_LIMIT_POST;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_PRDGEN_TN;" "&JOBSdir;/JREGIONAL_RUN_PRDGEN"</command>

      <nodes>{{ nnodes_run_prdgen }}:ppn={{ ppn_run_prdgen }}</nodes>
      <walltime>{{ wtime_run_prdgen }}</walltime>
      <memory>{{ mem_run_prdgen }}</memory>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <native>&SCHED_NATIVE_CMD;</native>

      <jobname>&TAG;_&RUN_PRDGEN_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join>&LOGDIR;/&RUN_PRDGEN_TN;{{ uscore_ensmem_name }}_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>TMMARK</name><value>tm00</value></envar>

      <dependency>
        <taskdep task="&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#"/>
      </dependency>

    </task>
  </metatask>
<!--
************************************************************************
************************************************************************
-->
<metatask name="&RUN_PRDGEN_TN;{{ uscore_ensmem_name }}_long">
    <var name="fhr"> {% for h in range(0, postproc_long_len_hrs+1) %}{{ " %03d" % h  }}{% endfor %} </var>
    <task name="&RUN_PRDGEN_TN;{{ uscore_ensmem_name }}_f#fhr#_long" cycledefs="prodcyc_long" maxtries="{{ maxtries_run_prdgen }}">

      &RSRV_PRDGEN;
      &WALL_LIMIT_POST;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_PRDGEN_TN;" "&JOBSdir;/JREGIONAL_RUN_PRDGEN"</command>

      <nodes>{{ nnodes_run_prdgen }}:ppn={{ ppn_run_prdgen }}</nodes>
      <walltime>{{ wtime_run_prdgen }}</walltime>
      <memory>{{ mem_run_prdgen }}</memory>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <native>&SCHED_NATIVE_CMD;</native>

      <jobname>&TAG;_&RUN_PRDGEN_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join>&LOGDIR;/&RUN_PRDGEN_TN;{{ uscore_ensmem_name }}_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>TMMARK</name><value>tm00</value></envar>

      <dependency>
        <taskdep task="&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#_long"/>
      </dependency>

    </task>
  </metatask>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{% if do_bufrsnd %}
  <task name="&RUN_BUFRSND_TN;" cycledefs="prodcyc_long" maxtries="1">

        &RSRV_POST;
        &WALL_LIMIT_BUFRSND;

        <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_BUFRSND_TN;" "&JOBSdir;/JREGIONAL_BUFRSND"</command>

        <nodes>{{ nnodes_run_bufrsnd }}:ppn={{ ppn_run_bufrsnd }}</nodes>
        <walltime>{{ wtime_run_bufrsnd }}</walltime>
        <nodesize>&NCORES_PER_NODE;</nodesize>

        <jobname>&TAG;_&RUN_BUFRSND_TN;</jobname>
        <join>&LOGDIR;/&RUN_BUFRSND_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

        <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
        <envar><name>USHdir</name><value>&USHdir;</value></envar>
        <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
        <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
        <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
        <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
        <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
        <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

        <envar><name>CYCLE_DIR</name><value><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
        <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
        <envar><name>TMMARK</name><value>tm00</value></envar>

        <dependency>
          <datadep age="00:10"><cyclestr>&COMIN_BASEDIR;/@Y@m@d@H/fcst_fv3lam/logf{{ "%03d" % postproc_long_len_hrs }}</cyclestr></datadep>
        </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if machine in ["JET", "HERA"]  %}
{%- if not do_ensemble %}
<!--
************************************************************************
************************************************************************
-->
  <metatask name="python_maps">

    <var name="tilelabel"> {{ tile_labels }} </var>
    <var name="tileset"> {{ tile_sets }} </var>
    <task name="python_maps{{ uscore_ensmem_name }}_#tilelabel#" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_post }}">

      &RSRV_GRAPHICS;
      &WALL_LIMIT_GRAPHICS;

      <walltime>{{ wtime_run_fcst_long }}</walltime>
      <nodes>{{ nnodes_run_graphics }}:ppn={{ ppn_run_graphics }}</nodes>

      <jobname>&TAG;_python{{ uscore_ensmem_name }}_<cyclestr>@H</cyclestr>_#tilelabel#</jobname>
      <join>&LOGDIR;/python{{ uscore_ensmem_name }}_#tilelabel#&LOGEXT;</join>
      <command>&LOAD_MODULES_RUN_TASK_FP; "run_graphics" "&JOBSdir;/JREGIONAL_RUN_PYTHON_GRAPHICS"</command>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>GRAPHICS_TYPE</name><value>maps</value></envar>
      <envar><name>TILES</name><value>#tileset#</value></envar>
      <envar><name>TILELABEL</name><value>#tilelabel#</value></envar>
      <envar><name>ENSCTRL_COMOUT_BASEDIR</name><value>&ENSCTRL_COMOUT_BASEDIR;</value></envar>

      <dependency>
        <or>
          <taskdep task="&RUN_PRDGEN_TN;{{ uscore_ensmem_name }}_f000"/>
          <taskdep task="&RUN_PRDGEN_TN;{{ uscore_ensmem_name }}_f000_long"/>
        </or>
      </dependency>
    </task>
  </metatask>
<!--
************************************************************************
************************************************************************
-->
  <task name="python_skewts{{ uscore_ensmem_name }}" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_post }}">

    &RSRV_GRAPHICS;
    &WALL_LIMIT_GRAPHICS;

    <walltime>{{ wtime_run_fcst_long }}</walltime>
    <nodes>{{ nnodes_run_graphics }}:ppn={{ ppn_run_graphics }}</nodes>

    <jobname>&TAG;_python{{ uscore_ensmem_name }}_<cyclestr>@H</cyclestr>_skewts</jobname>
    <join>&LOGDIR;/python_skewts{{ uscore_ensmem_name }}<cyclestr>_@H</cyclestr>&LOGEXT;</join>
    <command>&LOAD_MODULES_RUN_TASK_FP; "run_graphics" "&JOBSdir;/JREGIONAL_RUN_PYTHON_GRAPHICS"</command>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>GRAPHICS_TYPE</name><value>skewts</value></envar>
    <envar><name>ENSCTRL_COMOUT_BASEDIR</name><value>&ENSCTRL_COMOUT_BASEDIR;</value></envar>

    <dependency>
      <or>
        <taskdep task="&RUN_PRDGEN_TN;{{ uscore_ensmem_name }}_f000"/>
        <taskdep task="&RUN_PRDGEN_TN;{{ uscore_ensmem_name }}_f000_long"/>
      </or>
    </dependency>
  </task>
<!--
************************************************************************
************************************************************************
-->
{%- endif %}
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_run_fcst %}
  <task name="&RUN_FCST_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_run_fcst }}">

    &RSRV_FCST;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_FCST_TN;" "&JOBSdir;/JREGIONAL_RUN_FCST"</command>
  {%- if machine in ["JET", "HERA", "LINUX"]  %}
    <cores>{{ ncores_run_fcst }}</cores>
    <native>{{ native_run_fcst }}</native>
  {%- elif machine in ["WCOSS2"]  %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}:tpp={{ omp_num_threads_run_fcst }}</nodes>
    <native>&SCHED_NATIVE_CMD;</native>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- else %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- endif %}
    <native>&SCHED_NATIVE_CMD;</native>
    <walltime>{{ wtime_run_fcst }}</walltime>
    <jobname>&RUN_FCST_TN;{{ uscore_ensmem_name }}</jobname>
    <join>&LOGDIR;/&RUN_FCST_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&MAKE_ICS_TN;{{ uscore_ensmem_name }}"/>
        <taskdep task="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}"/>
      </and>
    </dependency>

  </task>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{%- if run_task_run_post %}
  {%- if sub_hourly_post %}
<!--
Define the post-processing task for first model output time.  The forecast 
hour corresponding to this output time is zero (formatted to the appropriate
number of digits), and the corresponding forecast minute is the first model 
time step dt_atmos, i.e. it is not zero.  This is because FV3 is designed 
such that its first output file contains fields at the first time step.  
It is for this reason that this task is not rolled into the metatask(s) 
further below.

Note that we wrap this task in a metatask in order to be able to declare
and use the variables fhr and fmn.  This allows the block of code inside
the <task> tag (except for the dependencies) to be identical to the ones 
later below for other output times.
-->
<!--
************************************************************************
************************************************************************
-->
  <metatask>
    <var name="fhr">000</var>
    <var name="fmn">00</var>
<!--
************************************************************************
************************************************************************
-->
    <task name="&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr##fmn#" cycledefs="prodcyc" maxtries="{{ maxtries_run_post }}">

      &RSRV_DEFAULT;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSdir;/JREGIONAL_RUN_POST"</command>

      <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
      <walltime>{{ wtime_run_post }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <native>&SCHED_NATIVE_CMD;</native>

      <jobname>&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr##fmn#</jobname>
      <join>&LOGDIR;/&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr##fmn#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>fmn</name><value>#fmn#</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

<!--
Note that because the forecast minutes and seconds corresponding to the
first model output time are not exactly zero, we use the jinja template
variable first_fv3_file_tstr instead of fhr and fmn to form the file 
names in the dependencies.
-->
      <dependency>
        <or>
          <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
          <and>
            <datadep age="05:00">&DYN_DIR;f{{ first_fv3_file_tstr }}.nc</datadep>
            <datadep age="05:00">&PHY_DIR;f{{ first_fv3_file_tstr }}.nc</datadep>
          </and>
        </or>
      </dependency>

    </task>
<!--
************************************************************************
************************************************************************
-->
  </metatask>
<!--
************************************************************************
************************************************************************
-->

<!--
Define the post-processing tasks for the second through last output minutes
of the first output hour (which is zero).  We use two metatasks for this.
The inner one is needed to loop over the minutes, and the outer one is
used in order to be able to declare and use the variable fhr.  Use of this
variable (along with the fmn variable in the inner metatask) allows the
block of code inside the <task> tag to be identical to the ones later below
for other output times.
-->
  <metatask name="&RUN_POST_TN;{{ uscore_ensmem_name }}_f000">

    <var name="fhr">000</var>
    <metatask>

      <var name="fmn">{% for min in range(delta_min, 60, delta_min) %}{{ " %02d" % min }}{% endfor %}</var>
<!--
************************************************************************
************************************************************************
-->
      <task name="&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr##fmn#" cycledefs="prodcyc" maxtries="{{ maxtries_run_post }}">

        &RSRV_DEFAULT;

        <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSdir;/JREGIONAL_RUN_POST"</command>

        <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
        <walltime>{{ wtime_run_post }}</walltime>
        <nodesize>&NCORES_PER_NODE;</nodesize>
        <native>&SCHED_NATIVE_CMD;</native>

        <jobname>&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr##fmn#</jobname>
	<join>&LOGDIR;/&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr##fmn#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

        <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
        <envar><name>USHdir</name><value>&USHdir;</value></envar>
        <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
        <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
        <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
        <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
        <envar><name>fhr</name><value>#fhr#</value></envar>
        <envar><name>fmn</name><value>#fmn#</value></envar>
        <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
        <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

        <dependency>
          <or>
            <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
            <and>
              <datadep age="05:00">&DYN_DIR;f#fhr#:#fmn#:00.nc</datadep>
              <datadep age="05:00">&PHY_DIR;f#fhr#:#fmn#:00.nc</datadep>
            </and>
          </or>
        </dependency>

      </task>
<!--
************************************************************************
************************************************************************
-->

    </metatask>

  </metatask>
  {%- endif %}

<!--
************************************************************************
************************************************************************
-->
  <metatask name="&RUN_POST_TN;{{ uscore_ensmem_name }}">
  {%- if sub_hourly_post %}
<!--
Define the post-processing tasks for the second through next-to-last model
output hours (and all output minutes for each such hour).  
-->
    <var name="fhr">{% for h in range(1, fcst_len_hrs) %}{{ " %03d" % h }}{% endfor %}</var>
    <metatask>
      <var name="fmn">{% for min in range(0, 60, delta_min) %}{{ " %02d" % min }}{% endfor %}</var>
<!--
************************************************************************
************************************************************************
-->
      <task name="&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr##fmn#" cycledefs="prodcyc" maxtries="{{ maxtries_run_post }}">
  {%- else %}
<!--
Define the post-processing tasks for each model output hour.  Note that
only one metatask is needed for this purpose (the inner one that loops 
over the hours), but we use two metatasks in order to be able to use the 
variable fmn, which here is always set to zero.  Use of this variable 
(along with the fhr variable in the inner metatask) allows the block of 
code inside the <task> tag to be identical to the case in which subhourly 
post-processing is performed (i.e. the case in which the minutes are not 
always zero).
-->
    <var name="fhr">{% for h in range(0, fcst_len_hrs+1) %}{{ " %03d" % h }}{% endfor %}</var>
      <task name="&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#" cycledefs="prodcyc" maxtries="{{ maxtries_run_post }}">
  {%- endif %}

        &RSRV_DEFAULT;
        <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSdir;/JREGIONAL_RUN_POST"</command>
        <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
        <walltime>{{ wtime_run_post }}</walltime>
        <nodesize>&NCORES_PER_NODE;</nodesize>
        <native>&SCHED_NATIVE_CMD;</native>
        {%- if sub_hourly_post %}
        <jobname>&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr##fmn#</jobname>
	<join>&LOGDIR;/&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr##fmn#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>
        {%- else %}
        <jobname>&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
	<join>&LOGDIR;/&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>
        {%- endif %}

        <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
        <envar><name>USHdir</name><value>&USHdir;</value></envar>
        <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
        <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
        <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
        <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
        {%- if sub_hourly_post %}
        <envar><name>fhr</name><value>#fhr#</value></envar>
        <envar><name>fmn</name><value>#fmn#</value></envar>
        {%- else %}
        <envar><name>fhr</name><value>#fhr#</value></envar>
        {%- endif %}
        <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
        <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

        <dependency>
          <or>
            <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
            <and>
            {%- if sub_hourly_post %}
              <datadep age="05:00">&DYN_DIR;f#fhr#:#fmn#:00.nc</datadep>
              <datadep age="05:00">&PHY_DIR;f#fhr#:#fmn#:00.nc</datadep>
            {%- else %}
              <datadep age="05:00">&DYN_DIR;f#fhr#.nc</datadep>
              <datadep age="05:00">&PHY_DIR;f#fhr#.nc</datadep>
            {%- endif %}
            </and>
          </or>
        </dependency>

      </task>
<!--
************************************************************************
************************************************************************
-->

    {%- if sub_hourly_post %}
    </metatask>
    {%- else %}
    {%- endif %}
  </metatask>

<!--
************************************************************************
************************************************************************
-->
<!--
Define the post-processing task for the last model output time.  The 
forecast hour corresponding to this output time is the length of the 
forecast (assuming it is specified in integer hours), and the corresponding 
minute is 0.  This task cannot be included in the metatask above because 
for a given hour, the latter loops over all the valid output minutes, 
whereas for this last hour, only the first minute must be considered.

Note that we wrap this task in a metatask in order to be able to declare
and use the variables fhr and fmn.  This allows the block of code inside
the <task> tag to be identical to the ones above for other output times.
-->
  {%- if sub_hourly_post %}
  <metatask>

    <var name="fhr">{{ "%03d" % fcst_len_hrs }}</var>
    <var name="fmn">00</var>
    <task name="&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr##fmn#" cycledefs="prodcyc" maxtries="{{ maxtries_run_post }}">

      &RSRV_DEFAULT;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSdir;/JREGIONAL_RUN_POST"</command>
      <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
      <walltime>{{ wtime_run_post }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <native>&SCHED_NATIVE_CMD;</native>
      <jobname>&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr##fmn#</jobname>
      <join>&LOGDIR;/&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr##fmn#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>fmn</name><value>#fmn#</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <dependency>
        <or>
          <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
          <and>
            <datadep age="05:00">&DYN_DIR;f#fhr#:#fmn#:00.nc</datadep>
            <datadep age="05:00">&PHY_DIR;f#fhr#:#fmn#:00.nc</datadep>
          </and>
        </or>
      </dependency>

    </task>

  </metatask>
  {%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{%- if run_task_plot_allvars %}
  <task name="&PLOT_ALLVARS_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_plot_allvars }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&PLOT_ALLVARS_TN;" "&JOBSdir;/JREGIONAL_PLOT_ALLVARS"</command>
    <nodes>{{ nnodes_plot_allvars }}:ppn={{ ppn_plot_allvars }}</nodes>
    <walltime>{{ wtime_plot_allvars }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {%- if machine not in ["WCOSS2"] %}
    <native>&SCHED_NATIVE_CMD;</native>
  {%- endif %}
    <jobname>&PLOT_ALLVARS_TN;</jobname>
    <join>&LOGDIR;/&PLOT_ALLVARS_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <dependency>
        {%- if write_dopost %}
      <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
        {%- else %}
      <metataskdep metatask="&RUN_POST_TN;{{ uscore_ensmem_name }}"/>
        {%- endif %}
    </dependency>

  </task>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{%- if run_task_get_obs_ccpa %}
  <task name="&GET_OBS_CCPA_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_get_obs_ccpa }}">

    &RSRV_HPSS;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_OBS;" "&JOBSdir;/JREGIONAL_GET_OBS_CCPA"</command>
    <nodes>{{ nnodes_get_obs_ccpa }}:ppn={{ ppn_get_obs_ccpa }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_get_obs_ccpa }}</memory>
  {%- endif %}
    <walltime>{{ wtime_get_obs_ccpa }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&GET_OBS_CCPA_TN;</jobname>
    <join>&LOGDIR;/&GET_OBS_CCPA_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(0, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>ACCUM</name><value>01</value></envar>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_get_obs_mrms %}
  <task name="&GET_OBS_MRMS_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_get_obs_mrms }}">

    &RSRV_HPSS;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_OBS;" "&JOBSdir;/JREGIONAL_GET_OBS_MRMS"</command>
    <nodes>{{ nnodes_get_obs_mrms }}:ppn={{ ppn_get_obs_mrms }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_get_obs_mrms }}</memory>
  {%- endif %}
    <walltime>{{ wtime_get_obs_mrms }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&GET_OBS_MRMS_TN;</jobname>
    <join>&LOGDIR;/&GET_OBS_MRMS_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&MRMS_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(0, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>SCRIPTSdir</name><value>&SCRIPTSdir;</value></envar>
    <envar><name>VAR</name><value>REFC RETOP</value></envar>
 
  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_get_obs_ndas %}
  <task name="&GET_OBS_NDAS_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_get_obs_ndas }}">

    &RSRV_HPSS;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_OBS;" "&JOBSdir;/JREGIONAL_GET_OBS_NDAS"</command>
    <nodes>{{ nnodes_get_obs_ndas }}:ppn={{ ppn_get_obs_ndas }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_get_obs_ndas }}</memory>
  {%- endif %}
    <walltime>{{ wtime_get_obs_ndas }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&GET_OBS_NDAS_TN;</jobname>
    <join>&LOGDIR;/&GET_OBS_NDAS_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&NDAS_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(0, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_vx_gridstat %}
  <task name="&VX_GRIDSTAT_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_vx_gridstat }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_GRIDSTAT"</command>
    <nodes>{{ nnodes_vx_gridstat }}:ppn={{ ppn_vx_gridstat }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_gridstat }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_gridstat }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_GRIDSTAT_TN;</jobname>
    <join>&LOGDIR;/&VX_GRIDSTAT_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(1, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>01</value></envar>
    {%- if do_ensemble %}
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    {%- endif %}

    <dependency>
      {%- if run_task_get_obs_ccpa %}
      <and>
        <taskdep task="&GET_OBS_CCPA_TN;"/>
        {%- if write_dopost %}
        <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
        {%- else %}
        <metataskdep metatask="&RUN_POST_TN;{{ uscore_ensmem_name }}"/>
        {%- endif %}
      </and>
      {%- else %}
        {%- if write_dopost %}
      <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
        {%- else %}
      <metataskdep metatask="&RUN_POST_TN;{{ uscore_ensmem_name }}"/>
        {%- endif %}
      {%- endif %}
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_vx_gridstat %}
  <task name="&VX_GRIDSTAT_REFC_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_vx_gridstat_refc }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_GRIDSTAT"</command>
    <nodes>{{ nnodes_vx_gridstat }}:ppn={{ ppn_vx_gridstat }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_gridstat }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_gridstat }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_GRIDSTAT_REFC_TN;</jobname>
    <join>&LOGDIR;/&VX_GRIDSTAT_REFC_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&MRMS_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(1, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>REFC</value></envar>
    {%- if do_ensemble %}
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    {%- endif %}

    <dependency>
      {%- if run_task_get_obs_mrms %}
      <and>
        <taskdep task="&GET_OBS_MRMS_TN;"/>
        {%- if write_dopost %}
        <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
        {%- else %}
        <metataskdep metatask="&RUN_POST_TN;{{ uscore_ensmem_name }}"/>
        {%- endif %}
      </and>
      {%- else %}
        {%- if write_dopost %}
      <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
        {%- else %}
      <metataskdep metatask="&RUN_POST_TN;{{ uscore_ensmem_name }}"/>
        {%- endif %}
      {%- endif %}
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_vx_gridstat %}
  <task name="&VX_GRIDSTAT_RETOP_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_vx_gridstat_retop }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_GRIDSTAT"</command>
    <nodes>{{ nnodes_vx_gridstat }}:ppn={{ ppn_vx_gridstat }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_gridstat }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_gridstat }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_GRIDSTAT_RETOP_TN;</jobname>
    <join>&LOGDIR;/&VX_GRIDSTAT_RETOP_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&MRMS_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(1, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>RETOP</value></envar>
    {%- if do_ensemble %}
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    {%- endif %}

    <dependency>
      {%- if run_task_get_obs_mrms %}
      <and>
        <taskdep task="&GET_OBS_MRMS_TN;"/>
        {%- if write_dopost %}
        <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
        {%- else %}
        <metataskdep metatask="&RUN_POST_TN;{{ uscore_ensmem_name }}"/>
        {%- endif %}
      </and>
      {%- else %}
        {%- if write_dopost %}
      <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
        {%- else %}
      <metataskdep metatask="&RUN_POST_TN;{{ uscore_ensmem_name }}"/>
        {%- endif %}
      {%- endif %}
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_vx_gridstat and fcst_len_hrs >= 3 %}
  <task name="&VX_GRIDSTAT_03h_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_vx_gridstat_03h }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_GRIDSTAT"</command>
    <nodes>{{ nnodes_vx_gridstat }}:ppn={{ ppn_vx_gridstat }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_gridstat }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_gridstat }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_GRIDSTAT_03h_TN;</jobname>
    <join>&LOGDIR;/&VX_GRIDSTAT_03h_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(3, fcst_len_hrs+1, 3) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>03</value></envar>
    {%- if do_ensemble %}
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    {%- endif %}

    <dependency>
      <taskdep task="&VX_GRIDSTAT_TN;{{ uscore_ensmem_name }}"/>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_vx_gridstat and fcst_len_hrs >= 6 %}
  <task name="&VX_GRIDSTAT_06h_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_vx_gridstat_06h }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_GRIDSTAT"</command>
    <nodes>{{ nnodes_vx_gridstat }}:ppn={{ ppn_vx_gridstat }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_gridstat }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_gridstat }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_GRIDSTAT_06h_TN;</jobname>
    <join>&LOGDIR;/&VX_GRIDSTAT_06h_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(6, fcst_len_hrs+1, 6) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>06</value></envar>
    {%- if do_ensemble %}
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    {%- endif %}

    <dependency>
      <taskdep task="&VX_GRIDSTAT_TN;{{ uscore_ensmem_name }}"/>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_vx_gridstat and fcst_len_hrs >= 24 %}
  <task name="&VX_GRIDSTAT_24h_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_vx_gridstat_24h }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_GRIDSTAT"</command>
    <nodes>{{ nnodes_vx_gridstat }}:ppn={{ ppn_vx_gridstat }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_gridstat }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_gridstat }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_GRIDSTAT_24h_TN;</jobname>
    <join>&LOGDIR;/&VX_GRIDSTAT_24h_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(24, fcst_len_hrs+1, 24) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>24</value></envar>
    {%- if do_ensemble %}
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    {%- endif %}

    <dependency>
      <taskdep task="&VX_GRIDSTAT_TN;{{ uscore_ensmem_name }}"/>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if run_task_vx_pointstat %}
  <task name="&VX_POINTSTAT_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_vx_pointstat }}">
    &RSRV_DEFAULT;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_POINTSTAT"</command>
    <nodes>{{ nnodes_vx_pointstat }}:ppn={{ ppn_vx_pointstat }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_pointstat }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_pointstat }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_POINTSTAT_TN;</jobname>
    <join>&LOGDIR;/&VX_POINTSTAT_TN;{{ uscore_ensmem_name }}<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&NDAS_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(0, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    {%- if do_ensemble %}
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    {%- endif %}

    <dependency>
      {%- if run_task_get_obs_ndas %}
      <and>
        <taskdep task="&GET_OBS_NDAS_TN;"/>
        {%- if write_dopost %}
        <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
        {%- else %}
        <metataskdep metatask="&RUN_POST_TN;{{ uscore_ensmem_name }}"/>
        {%- endif %}
      </and>
      {%- else %}
        {%- if write_dopost %}
      <taskdep task="&RUN_FCST_TN;{{ uscore_ensmem_name }}"/>
        {%- else %}
      <metataskdep metatask="&RUN_POST_TN;{{ uscore_ensmem_name }}"/>
        {%- endif %}
      {%- endif %}
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->

{%- if do_ensemble %}
  </metatask>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
{%- if run_task_vx_ensgrid %}
  <task name="&VX_ENSGRID_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID"</command>
    <nodes>{{ nnodes_vx_ensgrid }}:ppn={{ ppn_vx_ensgrid }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(1, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>01</value></envar>

    <dependency>
      <metataskdep metatask="run_ensemble"/>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->
{%- if fcst_len_hrs >= 3 %}
  <task name="&VX_ENSGRID_03h_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_03h }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID"</command>
    <nodes>{{ nnodes_vx_ensgrid }}:ppn={{ ppn_vx_ensgrid }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_03h_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_03h_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(3, fcst_len_hrs+1, 3) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>03</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_TN;"/>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if fcst_len_hrs >= 6 %}   
  <task name="&VX_ENSGRID_06h_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_06h }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID"</command>
    <nodes>{{ nnodes_vx_ensgrid }}:ppn={{ ppn_vx_ensgrid }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_06h_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_06h_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(6, fcst_len_hrs+1, 6) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>06</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_TN;"/>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- if fcst_len_hrs >= 24 %}
  <task name="&VX_ENSGRID_24h_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_24h }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID"</command>
    <nodes>{{ nnodes_vx_ensgrid }}:ppn={{ ppn_vx_ensgrid }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_24h_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_24h_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(24, fcst_len_hrs+1, 24) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>24</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_TN;"/>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
<task name="&VX_ENSGRID_REFC_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_refc }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID"</command>
    <nodes>{{ nnodes_vx_ensgrid }}:ppn={{ ppn_vx_ensgrid }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_REFC_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_REFC_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&MRMS_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(1, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>REFC</value></envar>

    <dependency>
      <metataskdep metatask="run_ensemble"/>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->

<task name="&VX_ENSGRID_RETOP_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_retop }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID"</command>
    <nodes>{{ nnodes_vx_ensgrid }}:ppn={{ ppn_vx_ensgrid }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_RETOP_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_RETOP_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&MRMS_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(1, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>RETOP</value></envar>

    <dependency>
      <metataskdep metatask="run_ensemble"/>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->
  <task name="&VX_ENSGRID_MEAN_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_mean }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID_MEAN"</command>
    <nodes>{{ nnodes_vx_ensgrid_mean }}:ppn={{ ppn_vx_ensgrid_mean }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid_mean }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid_mean }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_MEAN_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_MEAN_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(1, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>01</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_TN;"/>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->

  <task name="&VX_ENSGRID_PROB_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_prob }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID_PROB"</command>
    <nodes>{{ nnodes_vx_ensgrid_prob }}:ppn={{ ppn_vx_ensgrid_prob }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid_prob }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid_prob }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_PROB_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_PROB_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(1, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>01</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_TN;"/>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
{%- if fcst_len_hrs >= 3 %}
  <task name="&VX_ENSGRID_MEAN_03h_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_mean_03h }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID_MEAN"</command>
    <nodes>{{ nnodes_vx_ensgrid_mean }}:ppn={{ ppn_vx_ensgrid_mean }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid_mean }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid_mean }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_MEAN_03h_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_MEAN_03h_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(3, fcst_len_hrs+1, 3) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>03</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_03h_TN;"/>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->

  <task name="&VX_ENSGRID_PROB_03h_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_prob_03h }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID_PROB"</command>
    <nodes>{{ nnodes_vx_ensgrid_prob }}:ppn={{ ppn_vx_ensgrid_prob }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid_prob }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid_prob }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_PROB_03h_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_PROB_03h_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(3, fcst_len_hrs+1, 3) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>03</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_03h_TN;"/>
    </dependency>

  </task>
{%- endif %}

{%- if fcst_len_hrs >= 6 %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&VX_ENSGRID_MEAN_06h_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_mean_06h }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID_MEAN"</command>
    <nodes>{{ nnodes_vx_ensgrid_mean }}:ppn={{ ppn_vx_ensgrid_mean }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid_mean }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid_mean }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_MEAN_06h_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_MEAN_06h_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(6, fcst_len_hrs+1, 6) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>06</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_06h_TN;"/>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->

  <task name="&VX_ENSGRID_PROB_06h_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_prob_06h }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID_PROB"</command>
    <nodes>{{ nnodes_vx_ensgrid_prob }}:ppn={{ ppn_vx_ensgrid_prob }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid_prob }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid_prob }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_PROB_06h_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_PROB_06h_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(6, fcst_len_hrs+1, 6) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>06</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_06h_TN;"/>
    </dependency>

  </task>
{%- endif %}
{%- if fcst_len_hrs >= 24 %}
<!--
************************************************************************
************************************************************************
-->

  <task name="&VX_ENSGRID_MEAN_24h_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_mean_24h }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID_MEAN"</command>
    <nodes>{{ nnodes_vx_ensgrid_mean }}:ppn={{ ppn_vx_ensgrid_mean }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid_mean }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid_mean }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_MEAN_24h_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_MEAN_24h_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(24, fcst_len_hrs+1, 24) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>24</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_24h_TN;"/>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->

  <task name="&VX_ENSGRID_PROB_24h_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_prob_24h }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID_PROB"</command>
    <nodes>{{ nnodes_vx_ensgrid_prob }}:ppn={{ ppn_vx_ensgrid_prob }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid_prob }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid_prob }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_PROB_24h_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_PROB_24h_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&CCPA_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(24, fcst_len_hrs+1, 24) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>APCP</value></envar>
    <envar><name>ACCUM</name><value>24</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_24h_TN;"/>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&VX_ENSGRID_PROB_REFC_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_prob_refc }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID_PROB"</command>
    <nodes>{{ nnodes_vx_ensgrid_prob }}:ppn={{ ppn_vx_ensgrid_prob }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid_prob }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid_prob }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_PROB_REFC_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_PROB_REFC_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&MRMS_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(1, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>REFC</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_REFC_TN;"/>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->

  <task name="&VX_ENSGRID_PROB_RETOP_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_ensgrid_prob_retop }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSGRID_PROB"</command>
    <nodes>{{ nnodes_vx_ensgrid_prob }}:ppn={{ ppn_vx_ensgrid_prob }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_ensgrid_prob }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_ensgrid_prob }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSGRID_PROB_RETOP_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSGRID_PROB_RETOP_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&MRMS_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(1, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>
    <envar><name>VAR</name><value>RETOP</value></envar>

    <dependency>
      <taskdep task="&VX_ENSGRID_RETOP_TN;"/>
    </dependency>

  </task>
{%- endif %}

{%- if run_task_vx_enspoint %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&VX_ENSPOINT_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_enspoint }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSPOINT"</command>
    <nodes>{{ nnodes_vx_enspoint }}:ppn={{ ppn_vx_enspoint }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_enspoint }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_enspoint }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSPOINT_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSPOINT_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&NDAS_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
  </task>

<!--
************************************************************************
************************************************************************
-->
  <task name="&VX_ENSPOINT_MEAN_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_enspoint_mean }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSPOINT_MEAN"</command>
    <nodes>{{ nnodes_vx_enspoint_mean }}:ppn={{ ppn_vx_enspoint_mean }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_enspoint_mean }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_enspoint_mean }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSPOINT_MEAN_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSPOINT_MEAN_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&NDAS_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(0, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>

    <dependency>
      <taskdep task="&VX_ENSPOINT_TN;"/>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->
  <task name="&VX_ENSPOINT_PROB_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_vx_enspoint_prob }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&VX_TN;" "&JOBSdir;/JREGIONAL_RUN_VX_ENSPOINT_PROB"</command>
    <nodes>{{ nnodes_vx_enspoint_prob }}:ppn={{ ppn_vx_enspoint_prob }}</nodes>
  {%- if machine not in ["GAEA", "NOAACLOUD"]  %}
    <memory>{{ mem_vx_enspoint_prob }}</memory>
  {%- endif %}
    <walltime>{{ wtime_vx_enspoint_prob }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <native>&SCHED_NATIVE_CMD;</native>
    <jobname>&VX_ENSPOINT_PROB_TN;</jobname>
    <join>&LOGDIR;/&VX_ENSPOINT_PROB_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>OBS_DIR</name><value>&NDAS_OBS_DIR;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>FHR</name><value><cyclestr> {% for h in range(0, fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %} </cyclestr></value></envar>

    <dependency>
      <taskdep task="&VX_ENSPOINT_TN;"/>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
{%- endif %}

{%- if do_rrfs_dev -%}
<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_CLEAN_TN;" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_post }}">

    &RSRV_POST;

    <command>&JOBSdir;/../scripts/exregional_clean.ksh</command>

    <nodes> 1:ppn=1</nodes>
    <walltime>00:15:00</walltime>

    <jobname>&TAG;_&RUN_CLEAN_TN;</jobname>
    <join>&LOGDIR;/&RUN_CLEAN_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>NWGES_BASEDIR</name><value><cyclestr>&NWGES_BASEDIR;</cyclestr></value></envar>
{%- if do_ensemble %}
    <envar><name>nens</name><value><cyclestr>{{ num_ens_members }}</cyclestr></value></envar>
{%- else %}
    <envar><name>nens</name><value><cyclestr>0</cyclestr></value></envar>
{%- endif %}

  </task>
<!--
************************************************************************
************************************************************************
-->

{%- if machine in ["JET", "HERA"]  %}

<!--
************************************************************************
************************************************************************
-->
{%- if do_ensemble %}
  <task name="&RUN_ARCHIVE_TN;_ens" cycledefs="archive" maxtries="{{ maxtries_run_post }}">

    &RSRV_HPSS;

    <command>&JOBSdir;/../scripts/exregional_archive_ens.ksh</command>

    <nodes> 1:ppn=1</nodes>
    <walltime>23:00:00</walltime>
    <memory>24G</memory>

    <jobname>&TAG;_&RUN_ARCHIVE_TN;</jobname>
    <join>&LOGDIR;/&RUN_ARCHIVE_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>

  </task>

{%- else %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_ARCHIVE_TN;" cycledefs="archive" maxtries="{{ maxtries_run_post }}">

    &RSRV_HPSS;

    <command>&JOBSdir;/../scripts/exregional_archive.ksh</command>

    <nodes> 1:ppn=1</nodes>
    <walltime>08:00:00</walltime>
    <memory>24G</memory>

    <jobname>&TAG;_&RUN_ARCHIVE_TN;</jobname>
    <join>&LOGDIR;/&RUN_ARCHIVE_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{%- endif %}

{%- if machine in ["WCOSS2"]  %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_ARCHIVE_TN;" cycledefs="archive" maxtries="{{ maxtries_run_post }}">

    &RSRV_HPSS;

    <command>&JOBSdir;/../scripts/exregional_archive_emc.ksh</command>

    <nodes>1:ppn=1</nodes>
    <walltime>08:00:00</walltime>

    <jobname>&TAG;_&RUN_ARCHIVE_TN;</jobname>
    <join>&LOGDIR;/&RUN_ARCHIVE_TN;<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <dependency>
       <or>
          <and>
            <or>
             <streq><left>00</left><right><cyclestr>@H</cyclestr></right></streq>
             <streq><left>12</left><right><cyclestr>@H</cyclestr></right></streq>
            </or>
            <taskdep task="&RUN_PRDGEN_TN;_f060"/>
          </and>
          <and>
            <strneq><left>00</left><right><cyclestr>@H</cyclestr></right></strneq>
            <strneq><left>12</left><right><cyclestr>@H</cyclestr></right></strneq>
            <taskdep task="&RUN_PRDGEN_TN;_f003"/>
          </and>
       </or>
    </dependency>

  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->

{% if do_ensemble and do_ens_graphics %}
{%- if machine in ["JET", "HERA"] %}
<!--
************************************************************************
************************************************************************
-->
  <metatask name="ensemble_maps">

    <var name="tilelabel"> {{ tile_labels }} </var>
    <var name="tileset"> {{ tile_sets }} </var>
    <task name="python_maps_#tilelabel#" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_post }}">

      &RSRV_GRAPHICS;
      &WALL_LIMIT_GRAPHICS;

      <walltime>{{ wtime_run_fcst }}</walltime>
      <nodes>{{ nnodes_run_graphics }}:ppn={{ ppn_run_graphics }}</nodes>

      <jobname>&TAG;_python_<cyclestr>@H</cyclestr>_#tilelabel#</jobname>
      <join>&LOGDIR;/python_#tilelabel#&LOGEXT;</join>
      <command>&LOAD_MODULES_RUN_TASK_FP; "run_graphics" "&JOBSdir;/JREGIONAL_RUN_PYTHON_GRAPHICS"</command>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>GRAPHICS_TYPE</name><value>enspanel</value></envar>
      <envar><name>TILES</name><value>#tileset#</value></envar>
      <envar><name>TILELABEL</name><value>#tilelabel#</value></envar>
      <envar><name>ALL_LEADS</name><value>FALSE</value></envar>
      <envar><name>ENSCTRL_COMOUT_BASEDIR</name><value>&ENSCTRL_COMOUT_BASEDIR;</value></envar>

      <dependency>
        <and>
          <datadep age="00:00:00:05"><cyclestr>&ENSCTRL_COMOUT_DIR;/RRFS_CONUS.t@Hz.bgdawpf000.tm00.grib2</cyclestr></datadep>
          {%- for m in range(1, 10) %}
          <taskdep task="&RUN_PRDGEN_TN;_mem{{ "%04d" % m }}_f000"/>
          {%- endfor %}
        </and>
      </dependency>
    </task>
  </metatask>

{%- endif %}
{%- endif %}
<!--
************************************************************************
************************************************************************
-->

{%- if do_ensemble and do_ensfcst and do_enspost %}
<!--
************************************************************************
************************************************************************
-->
  <metatask name="enspost">
    <var name="fhr"> {% for h in range(0, postproc_len_hrs+1) %}{{ " %03d" % h  }}{% endfor %} </var>

    <task name="enspost_#fhr#" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_post }}">

      &RSRV_DEFAULT;
      &WALL_LIMIT_POST;

      <walltime>{{ wtime_run_enspost }}</walltime>
      <nodes>{{ nnodes_run_enspost }}:ppn={{ ppn_run_enspost }}</nodes>

      <jobname>&TAG;_enspost_<cyclestr>@H</cyclestr>_#fhr#</jobname>
      <join>&LOGDIR;/enspost_f#fhr#<cyclestr>_@Y@m@d@H</cyclestr>&LOGEXT;</join>
      <command>&LOAD_MODULES_RUN_TASK_FP; "run_enspost" "&JOBSdir;/JREGIONAL_RUN_ENSPOST"</command>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>USHdir</name><value>&USHdir;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
      <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>ENSCTRL_COMOUT_BASEDIR</name><value>&ENSCTRL_COMOUT_BASEDIR;</value></envar>

      <dependency>
        <and>
          <datadep age="00:00:00:05"><cyclestr>&ENSCTRL_COMOUT_DIR;/RRFS_CONUS.t@Hz.bgsfcf#fhr#.tm00.grib2</cyclestr></datadep>
          {%- for m in range(1, num_ens_members_fcst+1) %}
          <taskdep task="&RUN_PRDGEN_TN;_mem{{ "%04d" % m }}_f#fhr#"/>
          {%- endfor %}
        </and>
      </dependency>
    </task>
  </metatask>

<!--
************************************************************************
************************************************************************
-->
{% if machine in ["JET", "HERA"] %}
  <task name="python_enspost_maps" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_run_post }}">

    &RSRV_GRAPHICS;
    &WALL_LIMIT_GRAPHICS;

    <walltime>{{ wtime_run_enspost }}</walltime>
    <nodes>{{ nnodes_run_graphics }}:ppn={{ ppn_run_graphics }}</nodes>

    <jobname>&TAG;_python_<cyclestr>@H</cyclestr>_enspost_maps</jobname>
    <join>&LOGDIR;/python_enspost_maps&LOGEXT;</join>
    <command>&LOAD_MODULES_RUN_TASK_FP; "run_graphics" "&JOBSdir;/JREGIONAL_RUN_PYTHON_GRAPHICS"</command>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>USHdir</name><value>&USHdir;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>@M</cyclestr></value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>

    <envar><name>GRAPHICS_TYPE</name><value>maps</value></envar>
    <envar><name>TILES</name><value>full</value></envar>
    <envar><name>TILELABEL</name><value>full</value></envar>
    <envar><name>ALL_LEADS</name><value>FALSE</value></envar>
    <envar><name>ENSCTRL_COMOUT_BASEDIR</name><value>&ENSCTRL_COMOUT_BASEDIR;</value></envar>
    <envar><name>ENSPROD</name><value>ensprod</value></envar>
    <envar><name>IMAGES_FN</name><value>rrfs_ensprod.yml</value></envar>

    <dependency>
      <metataskdep metatask='enspost'/>
    </dependency>
  </task>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->

<!-- end of prod block -->
{%- endif %}
{%- endif %}
</workflow>
