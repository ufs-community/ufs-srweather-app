#!/bin/bash

#
#-----------------------------------------------------------------------
#
# This script gets either from the system directory or from mass store
# (HPSS) the files generated by the external model (specified by the 
# variable EXTRN_MDL_NAME) for either the initial conditions (ICs) or the
# lateral boundary conditions (LBCs).  Which of these we are considering
# depends on the value of the variable ICS_OR_LBCS, which should be 
# defined in the environment (when calling this script from a rocoto 
# workflow, the workflow should define this variable, e.g. using rocoto's
# <envar> tag).
#
# Note that when we refer to ICs, we are referring to not only the 
# atmospheric fields at the initial time but also various surface fields
# (which are for now time-independent) as well as the 0-th forecast hour
# LBCs.  Also, when we refer to LBCs, we are referring to the LBCs excluding
# the one at the 0-th hour.  
#
#-----------------------------------------------------------------------
#

#
#-----------------------------------------------------------------------
#
# Source the variable definitions file and the bash utility functions.
#
#-----------------------------------------------------------------------
#
. ${GLOBAL_VAR_DEFNS_FP}
. $USHDIR/source_util_funcs.sh
#
#-----------------------------------------------------------------------
#
# Source the file defining the function that will be used to set various
# external-model-related variables.
#
#-----------------------------------------------------------------------
#
. $USHDIR/get_extrn_mdl_file_dir_info.sh
#
#-----------------------------------------------------------------------
#
# Save current shell options (in a global array).  Then set new options
# for this script/function.
#
#-----------------------------------------------------------------------
#
{ save_shell_opts; set -u +x; } > /dev/null 2>&1
#
#-----------------------------------------------------------------------
#
# Get the full path to the file in which this script/function is located 
# (scrfunc_fp), the name of that file (scrfunc_fn), and the directory in
# which the file is located (scrfunc_dir).
#
#-----------------------------------------------------------------------
#
scrfunc_fp=$( readlink -f "${BASH_SOURCE[0]}" )
scrfunc_fn=$( basename "${scrfunc_fp}" )
scrfunc_dir=$( dirname "${scrfunc_fp}" )
#
#-----------------------------------------------------------------------
#
# Print message indicating entry into script.
#
#-----------------------------------------------------------------------
#
print_info_msg "
========================================================================
Entering script:  \"${scrfunc_fn}\"
In directory:     \"${scrfunc_dir}\"

This is the J-job script for the task that copies/fetches to a local di-
rectory (either from disk or HPSS) the external model files from which
initial or boundary condition files for the FV3 will be generated.
========================================================================"
#
#-----------------------------------------------------------------------
#
# Check whether output files from the specified external model (EXTRN_-
# MDL_NAME) are available on the specified cycle date and time (CDATE).
#
#-----------------------------------------------------------------------
#
case $EXTRN_MDL_NAME in

"GSMGFS")
# The transition date from the GSMGFS to the FV3GFS was 2019061212, i.e.
# this was the first official forecast with the FV3GFS.  So we set the
# last CDATE for the GSMGFS to the one 6 hours before this.
  CDATE_max="2019061206"
  if [ "$CDATE" -gt "$CDATE_max" ]; then
    print_err_msg_exit "\
Output from the specified external model (EXTRN_MDL_NAME) is not availa-
ble for the specified cycle date and time (CDATE) because the latter is
later than the last forecast date and time (CDATE_max) with this model:
  EXTRN_MDL_NAME = \"${EXTRN_MDL_NAME}\"
  CDATE_max = \"${CDATE_max}\"
  CDATE = \"${CDATE}\""
  fi
  ;;

"FV3GFS")
# The transition date from the GSMGFS to the FV3GFS was 2019061212, i.e.
# this was the first official forecast with the FV3GFS.  However, paral-
# lel runs with the FV3GFS go back to 2018121500.  So we set the first 
# CDATE for the FV3GFS to this date and time.
#  CDATE_min="2019061212"
  CDATE_min="2018121500"
  if [ "$CDATE" -lt "$CDATE_min" ]; then
    print_err_msg_exit "\
Output from the specified external model (EXTRN_MDL_NAME) is not availa-
ble for the specified cycle date and time (CDATE) because the latter is
earlier than the implementation date of this model:
  EXTRN_MDL_NAME = \"${EXTRN_MDL_NAME}\"
  CDATE_min = \"${CDATE_min}\"
  CDATE = \"${CDATE}\""
  fi
  ;;

"RAPX")
# Examination of the HPSS archives shows that the RAP data goes back to
# July 01, 2015.
  CDATE_min="2015070100"
  if [ "$CDATE" -lt "$CDATE_min" ]; then
    print_err_msg_exit "\
Output from the specified external model (EXTRN_MDL_NAME) is not availa-
ble for the specified cycle date and time (CDATE) because the latter is
earlier than the implementation date of this model:
  EXTRN_MDL_NAME = \"${EXTRN_MDL_NAME}\"
  CDATE_min = \"${CDATE_min}\"
  CDATE = \"${CDATE}\""
  fi
  ;;

"HRRRX")
# From the HRRR home page (https://rapidrefresh.noaa.gov/hrrr), the im-
# plementation of the first version of the operational HRRR was Septem-
# ber 30, 2014.
  CDATE_min="2014103000"
  if [ "$CDATE" -lt "$CDATE_min" ]; then
    print_err_msg_exit "\
Output from the specified external model (EXTRN_MDL_NAME) is not availa-
ble for the specified cycle date and time (CDATE) because the latter is
earlier than the implementation date of this model:
  EXTRN_MDL_NAME = \"${EXTRN_MDL_NAME}\"
  CDATE_min = \"${CDATE_min}\"
  CDATE = \"${CDATE}\""
  fi
  ;;

esac
#
#-----------------------------------------------------------------------
#
# Set the parameter that determines whether we want to get analysis or
# forecast files.  This depends on whether we want these files to gene-
# rate initial condition (IC) and surface field files or lateral bounda-
# ry condition (LBC) files for the SAR-FV3.  Also, set TIME_OFFSET_HRS,
# which is the offset (in hours) between the current cycle's starting 
# time and the starting time of the external model providing the LBCs.
#
#-----------------------------------------------------------------------
#
valid_vals_ICS_OR_LBCS=( "ICS" "LBCS" )
if [ "$ICS_OR_LBCS" = "ICS" ]; then
  ANL_OR_FCST="ANL"
  TIME_OFFSET_HRS="0"
elif [ "$ICS_OR_LBCS" = "LBCS" ]; then
  ANL_OR_FCST="FCST"
  TIME_OFFSET_HRS="$EXTRN_MDL_LBCS_OFFSET_HRS"
else
  valid_vals_ICS_OR_LBCS_str=$( printf "\"%s\" " "${valid_vals_ICS_OR_LBCS[@]}" )
  print_err_msg_exit "\
Invalid value specified for ICS_OR_LBCS:
  ICS_OR_LBCS = \"$ICS_OR_LBCS\"
Valid values are:
  ${valid_vals_ICS_OR_LBCS_str}"
fi
#
#-----------------------------------------------------------------------
#
# Create the directory EXTRN_MDL_FILES_BASEDIR_ICS if it doesn't al-
# ready exist.  This is the directory in which we will create a subdi-
# rectory for each cycle (i.e. for each CDATE) in which to store the 
# files from the external model.
#
#-----------------------------------------------------------------------
#
EXTRN_MDL_FILES_DIR="${CYCLE_DIR}/${EXTRN_MDL_NAME}/${ICS_OR_LBCS}"
#
#-----------------------------------------------------------------------
#
# Create the directory specific to the current forecast (whose starting
# date and time is specified in CDATE) in which to store the external 
# model files.  Then change location to that directory.
#
#-----------------------------------------------------------------------
#
mkdir_vrfy -p "${EXTRN_MDL_FILES_DIR}"
cd_vrfy ${EXTRN_MDL_FILES_DIR} || print_err_msg_exit "\
Could not change directory to EXTRN_MDL_FILES_DIR:
  EXTRN_MDL_FILES_DIR = \"${EXTRN_MDL_FILES_DIR}\""
#
#-----------------------------------------------------------------------
#
# Call the function that sets various external-model-related variables.
# See the function defintion file for the definitions of these varia-
# bles.
#
#-----------------------------------------------------------------------
#
get_extrn_mdl_file_dir_info \
  extrn_mdl_name="${EXTRN_MDL_NAME}" \
  anl_or_fcst="${ANL_OR_FCST}" \
  cdate_FV3SAR="${CDATE}" \
  time_offset_hrs="${TIME_OFFSET_HRS}" \
  varname_extrn_mdl_cdate="EXTRN_MDL_CDATE" \
  varname_extrn_mdl_lbc_update_fhrs="EXTRN_MDL_LBC_UPDATE_FHRS" \
  varname_extrn_mdl_fns="EXTRN_MDL_FNS" \
  varname_extrn_mdl_sysdir="EXTRN_MDL_SYSDIR" \
  varname_extrn_mdl_arcv_fmt="EXTRN_MDL_ARCV_FMT" \
  varname_extrn_mdl_arcv_fns="EXTRN_MDL_ARCV_FNS" \
  varname_extrn_mdl_arcv_fps="EXTRN_MDL_ARCV_FPS" \
  varname_extrn_mdl_arcvrel_dir="EXTRN_MDL_ARCVREL_DIR"
#
#-----------------------------------------------------------------------
#
# Call the ex-script for this J-job and pass to it the necessary varia-
# bles.
#
#-----------------------------------------------------------------------
#
EXTRN_MDL_FNS_str="( "$( printf "\"%s\" " "${EXTRN_MDL_FNS[@]}" )")"
EXTRN_MDL_ARCV_FNS_str="( "$( printf "\"%s\" " "${EXTRN_MDL_ARCV_FNS[@]}" )")"
EXTRN_MDL_ARCV_FPS_str="( "$( printf "\"%s\" " "${EXTRN_MDL_ARCV_FPS[@]}" )")"

$SCRIPTSDIR/exregional_get_extrn_files.sh \
  EXTRN_MDL_FNS="${EXTRN_MDL_FNS_str}" \
  EXTRN_MDL_SYSDIR="${EXTRN_MDL_SYSDIR}" \
  EXTRN_MDL_FILES_DIR="${EXTRN_MDL_FILES_DIR}" \
  EXTRN_MDL_ARCV_FNS="${EXTRN_MDL_ARCV_FNS_str}" \
  EXTRN_MDL_ARCV_FPS="${EXTRN_MDL_ARCV_FPS_str}" \
  EXTRN_MDL_ARCV_FMT="${EXTRN_MDL_ARCV_FMT}" \
  EXTRN_MDL_ARCVREL_DIR="${EXTRN_MDL_ARCVREL_DIR}" || \
print_err_msg_exit "\
Call to ex-script corresponding to J-job \"${scrfunc_fn}\" failed."
#
#-----------------------------------------------------------------------
#
# Print exit message.
#
#-----------------------------------------------------------------------
#
print_info_msg "
========================================================================
Exiting script:  \"${scrfunc_fn}\"
In directory:    \"${scrfunc_dir}\"
========================================================================"
#
#-----------------------------------------------------------------------
#
# Restore the shell options saved at the beginning of this script/func-
# tion.
#
#-----------------------------------------------------------------------
#
{ restore_shell_opts; } > /dev/null 2>&1

